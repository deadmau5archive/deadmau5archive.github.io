var apiUrl="https://dm5a.000webhostapp.com/api/",session=null,username=null,hcaptchaSiteKey="df633e96-6d53-441f-9061-374d557e8a1e";function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}var toTimestamp=e=>{var t=parseInt(e,10);return[Math.floor(t/3600)%24,Math.floor(t/60)%60,t%60].map(e=>e<10?"0"+e:e).join(":")};function load(e,t){var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="json",o.onload=function(){200===o.status&&t(o.response)},o.send()}function getCookie(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?t.pop().split(";").shift():null}function initSession(){var e=getCookie("d5a_session");if(e&&"expired"!==e){var t=JSON.parse(atob(e));t&&"username"in t&&"sessionid"in t&&(username=t.username,session=t.sessionid,reloadUserState())}}function login(){showLoginPane()}function logout(){localSessionDestroy(),closeLoginPane(),mkToast("logged out successfully. bye!","0a0"),reloadUserState()}function reloadUserState(){document.getElementById("username").innerHTML=session?"<i>"+username+"</i>":"Login","undefined"!=typeof reloadMarkerList&&reloadMarkerList(),"undefined"!=typeof reloadTagList&&reloadTagList()}function localSessionDestroy(){username=null,session=null,document.cookie="d5a_session=expired; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/"}function localSessionCreate(e,t,o){var n="";if(o){var a=new Date;a.setTime(a.getTime()+31536e7),n="expires="+a.toUTCString()+"; "}var s={username:e,sessionid:t};document.cookie="d5a_session="+btoa(JSON.stringify(s))+"; "+n+"path=/",initSession()}function closeLoginPane(){document.getElementById("loginPane").outerHTML=""}function btnFormLogin(){var e=document.getElementById("loginUsername").value.toLowerCase(),t=document.getElementById("loginPassword").value,o=document.getElementById("loginRemember").checked,n=document.getElementById("loginCaptcha").dataset.widgetId,a=hcaptcha.getResponse(n);e.length>0&&t.length>0?null!=a&&""!=a&&a.length>0?sessionCreate(e,t,a,t=>{"logged_in"in t&&(t.logged_in?(localSessionCreate(e,t.session_id,o),closeLoginPane(),mkToast("login successful! welcome, "+e,"0a0")):mkToast("login failed"+("reason"in t?": "+t.reason:""),"f55"))}):mkToast("please complete the captcha","f55"):mkToast("please enter a username and password","f55")}function btnFormRegister(){var e=document.getElementById("registerUsername").value.toLowerCase(),t=document.getElementById("registerPassword").value,o=document.getElementById("registerPassword2").value,n=document.getElementById("registerCaptcha").dataset.widgetId,a=hcaptcha.getResponse(n);e.length>0&&t.length>0&&o.length>0?o==t?null!=a&&""!=a&&a.length>0?accountCreate(e,t,a,t=>{"created"in t&&(t.created?(localSessionCreate(e,t.session_id,!1),closeLoginPane(),mkToast("registered successfully! welcome, "+e,"0a0")):mkToast("failed to create account"+("reason"in t?": "+t.reason:""),"f55"))}):mkToast("please complete the captcha","f55"):mkToast("passwords do not match","f55"):mkToast("please fill out all fields","f55")}function mkToast(e,t="47f"){var o=document.createElement("div");o.innerHTML=escapeHtml(e),o.className="toast",o.style.background="#"+t,document.body.appendChild(o),setTimeout(()=>{o.outerHTML=""},5e3),o.addEventListener("click",e=>{o.outerHTML=""})}function openPane(){var e=document.createElement("div");return e.className="pane",e.id="loginPane",document.body.appendChild(e),e}function exportStuff(e,t,o,n){var a="";"M"==e?(c=function(e){for(var s in data2={},e){for(var i of(vObj=e[s],vObjListNew=[],vObj))console.log(i),(o||void 0!==window.username&&window.username==i.by)&&vObjListNew.push({name:i.text,offset:i.offset,color:i.color,user:i.by});vObjListNew.length>0&&(data2[s]=vObjListNew)}if("json"==n)a=JSON.stringify({all_videos:t,all_users:o,data:data2});else if("txt"==n)for(var s in a="MARKERS on "+(t?"all videos":"video "+vidId)+" by "+(o?"all users":window.username)+"\n",a+="==========================\n",data2)for(var i of(a+="\nvideo "+s+"\n",a+="------------------\n",data2[s]))a+="("+toTimestamp(i.offset)+") "+i.name+" -- by "+i.user+"\n";exportShow(a)},void 0===window.vidId&&(t=!0),data=t?getMarkers(c):getMarkersVideo(window.vidId,c)):"T"==e&&getCategories(e=>{c=function(o){for(var s in console.log(e),console.log(o),categories2={},o)for(var i of o[s]){var r=e[i];categories2[i]={name:r.text,color:r.color}}var d={video_tags:o,tag_list:categories2};if("json"==n)a=JSON.stringify({all_videos:t,data:d});else if("txt"==n)for(var s in a="TAGS on "+(t?"all videos":"video "+vidId)+"\n",a+="==========================\n",o)for(var i of(a+="\nvideo "+s+"\n",a+="------------------\n",o[s]))a+=e[i].text+"\n";exportShow(a)},void 0===window.vidId&&(t=!0),data=t?getTags(c):getTagsVideo(window.vidId,c)})}function exportShow(e){document.getElementById("exportTf").value=e,document.getElementById("exportBox").style.display="block"}function showLoginPane(e=null){var t=openPane(),o=null!==session,n=document.createElement("div");n.className="modal",n.id="loginModal";var a='<div class="modalTitle"><h3>'+(o?"User options":"Login")+'</h3></div><div class="modalX"><button onclick="closeLoginPane()">&nbsp;x&nbsp;</button></div>';if(a+='<div style="clear:both;"></div><br>',o){a+="<h4>Export</h4>";var s={M:"Markers",T:"Tags"},i={txt:"text",json:"json"},r=[!1,!0];for(var d of(void 0===window.vidId&&(r=[!0]),["M","T"]))for(var l of(a+="<hr>",a+="<b>"+s[d]+"</b><br>",r)){a+="<i>"+(l?"All videos":"This video")+"</i><br>";var c="T"==d?[!0]:[!1,!0];for(var u of c){for(var p of(a+=(u?"all":"my")+": ",["txt","json"]))a+="<button onclick=\"exportStuff('"+d+"',"+l+","+u+",'"+p+"')\">as "+i[p]+"</button> ";u||(a+="&mdash; ")}a+="<br>"}a+="<hr>",a+='<div style="display:none;" id="exportBox"><b>Export contents</b><br><i>copy/paste the text from this text field:</i><br><textarea style="width:100%;resize:none;" rows=5 id="exportTf"></textarea><hr></div>',a+="<br>",a+='<a href="#!" onclick="logout()" class="shade" style="color:#f55;"><b>Logout</b></a>'}else e&&(a+='<div class="loginNote">'+e+"</div><br>"),a+='<input type="text" id="loginUsername" placeholder="username"></input><br>',a+='<input type="password" id="loginPassword" placeholder="password"></input><br>',a+='<label><input type="checkbox" id="loginRemember"></input> remember me</label><br><br>',a+='<div id="loginCaptcha"></div><br>',a+='<button onclick="btnFormLogin()">Login</button><br><br>',a+='&#8594; Don\'t have an account? <a href="#!" onclick="showRegisterForm()" class="shade">Register</a><br>',a+='&#8594; <a href="#!" onclick="forgotPassword()" class="shade" id="forgotPasswordLink">I forgot my password</a>';if(n.innerHTML=a,t.appendChild(n),!o){document.getElementById("loginUsername").focus();var g=hcaptcha.render("loginCaptcha",{sitekey:hcaptchaSiteKey,theme:"dark"});document.getElementById("loginCaptcha").dataset.widgetId=g}}function showRegisterForm(){document.getElementById("loginModal").innerHTML='<div class="modalTitle"><h3>Register</h3></div><div class="modalX"><button onclick="closeLoginPane()">&nbsp;x&nbsp;</button></div><div style="clear:both;"></div><br><input type="text" id="registerUsername" placeholder="username"></input><br><input type="password" id="registerPassword" placeholder="password"></input><br><input type="password" id="registerPassword2" placeholder="repeat password"></input><br><br><div id="registerCaptcha"></div><br><button onclick="btnFormRegister()">Create account</button><br>',document.getElementById("registerUsername").focus();var e=hcaptcha.render("registerCaptcha",{sitekey:hcaptchaSiteKey,theme:"dark"});document.getElementById("registerCaptcha").dataset.widgetId=e}function forgotPassword(){mkToast("sucks to suck (message me on discord)","000")}function sessionCreate(e,t,o,n){apiPost({t:"session_create"},{username:e,password:t,captcha:o},n)}function accountCreate(e,t,o,n){apiPost({t:"account_create"},{username:e,password:t,captcha:o},n)}function markerCreate(e,t,o){if(!session)return!1;apiPost({t:"marker_create"},{video:e,text:t.name,color:t.color,offset:t.time},o)}function markerUpdate(e,t,o){if(!session)return!1;apiPost({t:"marker_update",i:e},{text:t.name,color:t.color,offset:t.time},o)}function markerDestory(e,t){apiGet({t:"marker_destroy",i:e},t)}function tagCreate(e,t,o){if(!session)return!1;apiPost({t:"tag_create"},{text:t.name,color:t.color},o)}function tagDestroy(e,t){apiGet({t:"tag_destroy",i:e},t)}function apiGet(e,t){apiRequest(e,null,t)}function apiPost(e,t,o){apiRequest(e,t,o)}function apiRequest(e,t,o){session&&(e.a=session);var n=apiUrl+"?"+obj2QueryString(e);console.info("[api] "+n);var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var e=JSON.parse(a.responseText);"status"in e?1==e.status?o("data"in e?e.data:null):0==e.status&&"error"in e?mkToast("ERROR: "+e.error,"f55"):console.error("invalid response"):console.error("no response status")}},t?(a.open("POST",n,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.send(obj2QueryString(t))):(a.open("GET",n,!0),a.send(null))}function getMarkers(e){apiGet({t:"get_markers"},e)}function getMarkersVideo(e,t){apiGet({t:"get_markers",v:e},t)}function getCategories(e){apiGet({t:"list_tags"},e)}function setTagsVideo(e,t,o,n){apiGet({t:"tag_set",s:o?1:0,v:e,i:t},n)}function getTags(e){apiGet({t:"get_tags"},e)}function getTagsVideo(e,t){apiGet({t:"get_tags",v:e},t)}function obj2QueryString(e){var t=[];for(var o in e)e.hasOwnProperty(o)&&t.push(encodeURIComponent(o)+"="+encodeURIComponent(e[o]));return t.join("&")}window.addEventListener("load",function(e){initSession()},!1);
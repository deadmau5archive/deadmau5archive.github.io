var apiUrl="https://api.deadmau5archive.cc/api/",staticUrl="https://static.deadmau5archive.cc/",captchaRequired=!0,session=null,username=null,sessionLoaded=!1,hcaptchaSiteKey="df633e96-6d53-441f-9061-374d557e8a1e";function escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}var toTimestamp=e=>{var t,o,n,s=parseInt(e,10);return[Math.floor(s/3600)%24,Math.floor(s/60)%60,s%60].map(e=>e<10?"0"+e:e).join(":")};function load(e,t,o=null){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="json",n.onload=function(){200===n.status?t(n.response):null!=o&&o()},n.send()}function getCookie(e){let t=`; ${document.cookie}`,o=t.split(`; ${e}=`);return 2===o.length?o.pop().split(";").shift():null}function initSession(){if(null!==sessionStorage.getItem("welcomeMessage")){try{var e=JSON.parse(sessionStorage.getItem("welcomeMessage"));mkToast(e.message,e.color)}catch(t){}sessionStorage.removeItem("welcomeMessage")}var o=getCookie("d5a_session"),n=null;if(o&&"expired"!==o)try{var s=JSON.parse(atob(o));s&&"sessionid"in s&&(n=s.sessionid)}catch(a){}null!==n?sessionVerify(n,e=>{e.auth&&(username=e.username,session=e.session.session_id,reloadUserState()),window.sessionLoaded=!0},()=>{window.sessionLoaded=!0}):window.sessionLoaded=!0}function waitforSession(e){window.setTimeout(function(){window.sessionLoaded?e():waitforSession(e)},50)}function login(){showLoginPane()}function logout(){localSessionDestroy(),sessionDestory(e=>{}),closeLoginPane(),sessionStorage.setItem("welcomeMessage",JSON.stringify({message:"logged out successfully. bye!",color:"0a0"})),location.reload()}function registerReloadUserStateCallback(e){reloadUserStateCallbacks.push(e)}function reloadUserState(){if(document.getElementById("username").innerHTML=session?"<i>"+username+"</i>":"Login",sessionLoaded)for(cb of reloadUserStateCallbacks)cb()}function localSessionDestroy(){username=null,session=null,document.cookie="d5a_session=expired; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/"}function localSessionCreate(e,t=null){var o="";null!==t&&(t=parseInt(t),o="expires="+new Date(1e3*t).toUTCString()+"; "),document.cookie="d5a_session="+btoa(JSON.stringify({sessionid:e}))+"; "+o+"path=/"}function closeLoginPane(e=!1){document.getElementById("loginPane").outerHTML="",null!=loginPaneCallback&&(loginPaneCallback(e),loginPaneCallback=null)}function btnFormLogin(){var e=document.getElementById("loginUsername").value.toLowerCase(),t=document.getElementById("loginPassword").value,o=document.getElementById("loginRemember").checked,n=document.getElementById("loginCaptcha").dataset.widgetId,s=hcaptcha.getResponse(n);e.length>0&&t.length>0?null!=s&&""!=s&&s.length>0||!captchaRequired?sessionCreate(e,t,o,s,t=>{"logged_in"in t&&(t.logged_in?(localSessionCreate(t.session.session_id,o?t.session.expires_at:null),closeLoginPane(!0),sessionStorage.setItem("welcomeMessage",JSON.stringify({message:"login successful! welcome, "+e,color:"0a0"})),location.reload()):mkToast("login failed"+("reason"in t?": "+t.reason:""),"f55"))}):mkToast("please complete the captcha","f55"):mkToast("please enter a username and password","f55")}function btnFormRegister(){var e=document.getElementById("registerUsername").value.toLowerCase(),t=document.getElementById("registerPassword").value,o=document.getElementById("registerPassword2").value,n=document.getElementById("registerCaptcha").dataset.widgetId,s=hcaptcha.getResponse(n);e.length>0&&t.length>0&&o.length>0?o==t?null!=s&&""!=s&&s.length>0||!captchaRequired?accountCreate(e,t,s,t=>{"created"in t&&(t.created?(localSessionCreate(t.session.session_id,null),closeLoginPane(!0),sessionStorage.setItem("welcomeMessage",JSON.stringify({message:"registered successfully! welcome, "+e,color:"0a0"})),location.reload()):mkToast("failed to create account"+("reason"in t?": "+t.reason:""),"f55"))}):mkToast("please complete the captcha","f55"):mkToast("passwords do not match","f55"):mkToast("please fill out all fields","f55")}function mkToast(e,t="47f"){var o=document.createElement("div");o.innerHTML=escapeHtml(e),o.className="toast",o.style.background="#"+t,document.body.appendChild(o),setTimeout(()=>{o.outerHTML=""},5e3),o.addEventListener("click",e=>{o.outerHTML=""})}function openPane(){var e=document.createElement("div");return e.className="pane",e.id="loginPane",document.body.appendChild(e),e}function exportStuff(e,t,o,n){var s="";"M"==e?(c=function(e){for(var a in data2={},e){for(var i of(vObj=e[a],vObjListNew=[],vObj))console.log(i),(o||void 0!==window.username&&window.username==i.by)&&vObjListNew.push({name:i.text,offset:i.offset,color:i.color,user:i.by});vObjListNew.length>0&&(data2[a]=vObjListNew)}if("json"==n)s=JSON.stringify({all_videos:t,all_users:o,data:data2});else if("txt"==n)for(var a in s="MARKERS on "+(t?"all videos":"video "+vidId)+" by "+(o?"all users":window.username)+"\n",s+="==========================\n",data2)for(var i of(s+="\nvideo "+a+"\n",s+="------------------\n",data2[a]))s+="("+toTimestamp(i.offset)+") "+i.name+" -- by "+i.user+"\n";exportShow(s)},void 0===window.vidId&&(t=!0),data=t?getMarkers(c):getMarkersVideo(window.vidId,c)):"T"==e&&getCategories(e=>{c=function(o){for(var a in console.log(e),console.log(o),categories2={},o)for(var i of o[a]){var r=e[i];categories2[i]={name:r.text,color:r.color}}var l={video_tags:o,tag_list:categories2};if("json"==n)s=JSON.stringify({all_videos:t,data:l});else if("txt"==n)for(var a in s="TAGS on "+(t?"all videos":"video "+vidId)+"\n",s+="==========================\n",o)for(var i of(s+="\nvideo "+a+"\n",s+="------------------\n",o[a]))s+=e[i].text+"\n";exportShow(s)},void 0===window.vidId&&(t=!0),data=t?getTags(c):getTagsVideo(window.vidId,c)})}function exportShow(e){document.getElementById("exportTf").value=e,document.getElementById("exportBox").style.display="block"}function whenAvailable(e,t){window.setTimeout(function(){window[e]?t():whenAvailable(e,t)},100)}window.addEventListener("load",function(e){initSession()},!1),reloadUserStateCallbacks=[];var loginPaneCallback=null;function showLoginPane(e=null,t=null){var o=openPane(),n=null!==session;null!=t&&(loginPaneCallback=t);var s=document.createElement("div");s.className="modal",s.id="loginModal";var a='<div class="modalTitle"><h3>'+(n?"User options":"Login")+'</h3></div><div class="modalX"><button onclick="closeLoginPane()">&nbsp;x&nbsp;</button></div>';if(a+='<div style="clear:both;"></div><br>',n){a+="<h4>Export</h4>";var i={M:"Markers",T:"Tags"},r={txt:"text",json:"json"},l=[!1,!0];for(var d of(void 0===window.vidId&&(l=[!0]),["M","T"]))for(var u of(a+="<hr>",a+="<b>"+i[d]+"</b><br>",l)){a+="<i>"+(u?"All videos":"This video")+"</i><br>";var g="T"==d?[!0]:[!1,!0];for(var p of g){for(var f of(a+=(p?"all":"my")+": ",["txt","json"]))a+="<button onclick=\"exportStuff('"+d+"',"+u+","+p+",'"+f+"')\">as "+r[f]+"</button> ";p||(a+="&mdash; ")}a+="<br>"}a+="<hr>",a+='<div style="display:none;" id="exportBox"><b>Export contents</b><br><i>copy/paste the text from this text field:</i><br><textarea style="width:100%;resize:none;" rows=5 id="exportTf"></textarea><hr></div>',a+="<br><br>",a+="<h4>Manage account connections</h4> <hr>",a+='<a href="/connect_discord" class="shade">Discord</a><br>',a+="<hr>",a+="<br><br>",a+='<a href="#!" onclick="logout()" class="shade" style="color:#f55;"><b>Logout</b></a>'}else e&&(a+='<div class="loginNote">'+e+"</div><br>"),a+='<input type="text" id="loginUsername" placeholder="username"></input><br>',a+='<input type="password" id="loginPassword" placeholder="password"></input><br>',a+='<label><input type="checkbox" id="loginRemember"></input> remember me</label><br><br>',a+='<div id="loginCaptcha"></div><br>',a+='<button onclick="btnFormLogin()" disabled id="btnLoginSubmit">Login</button><br><br>',a+='&#8594; Don\'t have an account? <a href="#!" onclick="showRegisterForm()" class="shade">Register</a><br>',a+='&#8594; <a href="#!" onclick="forgotPassword()" class="shade" id="forgotPasswordLink">I forgot my password</a>';s.innerHTML=a,o.appendChild(s),n||(document.getElementById("loginUsername").focus(),whenAvailable("hcaptcha",()=>{var e=hcaptcha.render("loginCaptcha",{sitekey:hcaptchaSiteKey,theme:"dark"});document.getElementById("loginCaptcha").dataset.widgetId=e,document.getElementById("btnLoginSubmit").disabled=!1}))}function showRegisterForm(){var e='<div class="modalTitle"><h3>Register</h3></div><div class="modalX"><button onclick="closeLoginPane()">&nbsp;x&nbsp;</button></div>';e+='<div style="clear:both;"></div><br>',e+='<input type="text" id="registerUsername" placeholder="username"></input><br>',e+='<input type="password" id="registerPassword" placeholder="password"></input><br>',e+='<input type="password" id="registerPassword2" placeholder="repeat password"></input><br><br>',e+='<div id="registerCaptcha"></div><br>',e+='<button onclick="btnFormRegister()" disabled id="btnRegisterSubmit">Create account</button><br>',document.getElementById("loginModal").innerHTML=e,document.getElementById("registerUsername").focus(),whenAvailable("hcaptcha",()=>{var e=hcaptcha.render("registerCaptcha",{sitekey:hcaptchaSiteKey,theme:"dark"});document.getElementById("registerCaptcha").dataset.widgetId=e,document.getElementById("btnRegisterSubmit").disabled=!1})}function forgotPassword(){mkToast("sucks to suck (message me on discord)","000")}function sessionCreate(e,t,o,n,s){apiPost({t:"session_create"},{username:e,password:t,remember:o?1:0,captcha:n},s)}function sessionVerify(e,t,o=null){apiPost({t:"session_verify"},{auth_token:e},t,o)}function sessionDestory(e){apiGet({t:"session_destory"},e)}function accountCreate(e,t,o,n){apiPost({t:"account_create"},{username:e,password:t,captcha:o},n)}function markerCreate(e,t,o){if(!session)return!1;apiPost({t:"marker_create"},{video:e,text:t.name,color:t.color,offset:t.time,vsig:window.vSigValue},o)}function markerUpdate(e,t,o){if(!session)return!1;apiPost({t:"marker_update",i:e},{text:t.name,color:t.color,offset:t.time},o)}function markerDestory(e,t){apiGet({t:"marker_destroy",i:e},t)}function tagCreate(e,t,o){if(!session)return!1;apiPost({t:"tag_create"},{text:t.name,color:t.color},o)}function tagDestroy(e,t){apiGet({t:"tag_destroy",i:e},t)}function apiGet(e,t,o=null){apiRequest(e,null,t,o)}function apiPost(e,t,o,n=null){apiRequest(e,t,o,n)}function apiRequest(e,t,o,n=null){var s=apiUrl+"?"+obj2QueryString(e),a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==a.readyState){if(200==a.status){var e=null;try{e=JSON.parse(a.responseText)}catch(t){console.error("invalid json"),null!==n&&n()}null!==e&&("status"in e?1==e.status?"data"in e?o(e.data):o(null):0==e.status&&"error"in e?(mkToast("ERROR: "+e.error,"f55"),null!==n&&n()):(console.error("invalid response"),null!==n&&n()):(console.error("no response status"),null!==n&&n()))}else null!==n&&n()}},a.open(t?"POST":"GET",s,!0),t&&(a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t=obj2QueryString(t)),session&&a.setRequestHeader("Authorization","Bearer "+session),a.send(t)}function getMarkers(e){apiGet({t:"get_markers"},e)}function getMarkersVideo(e,t){apiGet({t:"get_markers",v:e},t)}function getCategories(e){apiGet({t:"list_tags"},e)}function setTagsVideo(e,t,o,n){apiGet({t:"tag_set",s:o?1:0,v:e,i:t,vsig:window.vSigValue},n)}function getTags(e){apiGet({t:"get_tags"},e)}function getTagsVideo(e,t){apiGet({t:"get_tags",v:e},t)}function obj2QueryString(e){var t=[];for(var o in e)e.hasOwnProperty(o)&&t.push(encodeURIComponent(o)+"="+encodeURIComponent(e[o]));return t.join("&")}function discordAccountGet(e){apiGet({t:"discord_connection",type:"get"},e)}function discordAccountConnect(e,t){apiGet({t:"discord_connection",type:"connect",token:e},t)}function discordAccountDisconnect(e){apiGet({t:"discord_connection",type:"disconnect"},e)}function discordAccountResync(e){apiGet({t:"discord_connection",type:"resync"},e)}function getVideoAccess(e,t){apiGet({t:"get_video",video_id:e},t)}function getReverseVideo(e,t){apiGet({t:"route_video",ytid:e},t)}function getUserGroups(e){apiGet({t:"get_user_groups"},e)}
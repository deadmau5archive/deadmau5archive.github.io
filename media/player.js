var player,playerContainer,boundingRect,playerChat,playerChatType,vidId,theatreModeToggleBtn,descBarToggleBtn,descBarToggleBtn2,videoBox,navBox,descBox,timelineBox,progressInfo,localTimeInfo,videoStartTime,chatTabs,markersPane,vidIdMrk,progressInfo2="",videoDuration=0,nPartId=0,nPartNum=0;window.addEventListener("load",function(e){loadPlayer(),playerContainer=document.getElementById("playerContainer"),videoBox=document.getElementById("videoBox"),navBox=document.getElementsByClassName("navbox")[0],playerChat=document.getElementById("player_chat"),playerChatType=document.getElementById("chat").dataset.chattype,vidId=document.getElementById("chat").dataset.id,nPartId=document.getElementById("chat").dataset.p,nPartNum=document.getElementById("chat").dataset.np,timelineBox=document.getElementsByClassName("videoTimelineInfoBox")[0],vidIdMrk=vidId,nPartNum>1&&(vidIdMrk=vidId+"/"+nPartId),descBox=document.getElementById("desc"),(theatreModeToggleBtn=document.createElement("div")).setAttribute("id","toggleTheatreBtn"),theatreModeToggleBtn.className="descBtn",theatreModeToggleBtn.innerHTML='<div onclick="toggleTheatre()"><img src="/media/theatre.png" class="icon"></div>',descBox.appendChild(theatreModeToggleBtn),(descBarToggleBtn=document.createElement("div")).className="descBtn",descBarToggleBtn.innerHTML='<div onclick="toggleDescBar()"><img src="/media/descbtn.png" class="icon"></div>',descBarToggleBtn.style.right="50px",descBox.appendChild(descBarToggleBtn),(descBarToggleBtn2=descBarToggleBtn.cloneNode(!0)).innerHTML='<div onclick="toggleDescBar()"><img src="/media/descbtn2.png" class="icon"></div>',descBarToggleBtn2.style.top="20px",descBarToggleBtn2.style.right="28px",descBarToggleBtn2.style.zIndex="1",descBarToggleBtn2.style.display="none",descBarToggleBtn2Cnt=document.createElement("div"),descBarToggleBtn2Cnt.style.position="relative",descBarToggleBtn2Cnt.style.width="100%",descBarToggleBtn2Cnt.style.height=0,descBarToggleBtn2Cnt.appendChild(descBarToggleBtn2),videoBox.appendChild(descBarToggleBtn2Cnt),(progressInfo=document.createElement("div")).className="descRight",progressInfo.innerHTML="00:00:00",descBox.appendChild(progressInfo),(localTimeInfo=document.createElement("div")).className="descRight localTime",localTimeInfo.title="JoelTimeâ„¢",localTimeInfo.innerHTML="00:00",localTimeInfo.style.display="none",localTimeInfo.onclick=function(){timeFormat24h=!timeFormat24h,updateTimestamp()},descBox.appendChild(localTimeInfo),chatTabs=document.getElementById("chat_tabs"),recalculateSizes(),window.onresize=function(){recalculateSizes()};var t=document.getElementById("videoCount");t&&load("/about/videocount.txt",function(e){var a=t.dataset.count;t.innerHTML+=" / "+e[a]})},!1);var timeFormat24h=!0;function updateTimestamp(){if(null!=player){progressInfo.innerHTML=toTimestamp(player.getCurrentTime())+" / "+progressInfo2;var e=Math.floor(videoStartTime+player.getCurrentTime()),t=new Date(1e3*e).toLocaleString("en-US",{timeZone:"America/Toronto"}),a=new Date(t),n=a.getHours(),o=a.getMinutes();localTimeInfo.innerHTML=timeFormat24h?(n<10?"0"+n:n)+":"+(o<10?"0"+o:o):(n%12==0?12:n%12)+":"+(o<10?"0"+o:o)+" "+(n<12?"AM":"PM"),localTimeInfo.style.display="block"}}var descBarVisible=!0,descBarHidingAvailable=!0;function toggleDescBar(){showDescBar(descBarVisible=!descBarVisible),recalculateSizes()}function showDescBar(e){e?(descBox.style.display="block",timelineBox.style.display="block",descBarToggleBtn.style.display="block",descBarToggleBtn2.style.display="none",null!=chatTabs&&(chatTabs.style.display="block")):(descBox.style.display="none",timelineBox.style.display="none",descBarToggleBtn.style.display="none",descBarToggleBtn2.style.display="block",null!=chatTabs&&(chatTabs.style.display="none"))}var chatInit=!1,theatreMode=!1,bodyScrollTop=0;function toggleTheatre(){(theatreMode=!theatreMode)?(bodyScrollTop=window.pageYOffset||document.documentElement.scrollTop,playerContainer.className="theatre",playerChat.className="theatre",theatreModeToggleBtn.className="descBtn theatre",document.body.style.overflow="hidden"):(playerContainer.className="",theatreModeToggleBtn.className="descBtn",recalculateSizes(),document.body.style.overflow="",window.scrollTo(0,bodyScrollTop))}function playerChatModeChange(e){(descBarHidingAvailable=!e)?showDescBar(descBarVisible):(showDescBar(!0),descBarToggleBtn.style.display="none",descBarToggleBtn2.style.display="none")}function recalculateSizes(){if(!theatreMode){var e=window.innerWidth-18;if(e>=960){descBarHidingAvailable&&playerChatModeChange(!0);var t=1436-e,a=Math.min(1024,1024-t);videoBox.style.width=a+"px",navBox.style.width=a+"px",setTimeout(()=>{(boundingRect=videoBox.getBoundingClientRect()).y+=window.scrollY;playerChat.style.left=a+20+"px",playerChat.style.top=boundingRect.y+0+"px",playerChat.className="right";var e=2;"mixer"==playerChatType&&(e=0),playerChat.style.height=boundingRect.height-e-0+"px",chatTabs.className="right",chatTabs.style.left=a+20+"px",chatTabs.style.top=boundingRect.y-52+0+"px"},1)}else descBarHidingAvailable||playerChatModeChange(!1),videoBox.style.width="100%",navBox.style.width="100%",setTimeout(()=>{playerChat.className="",playerChat.style.left=0,playerChat.style.top=0,playerChat.style.height=Math.min(.5*playerContainer.clientWidth,260)+"px",chatTabs.className="0",chatTabs.style.left=0,chatTabs.style.top=0},1);playerContainer.style.height=playerContainer.clientWidth/16*9+"px",chatInit||(playerChat.style.display="block",chatInit=!0)}}function loadPlayer(){var e=document.getElementById("youtube-player");videoStartTime=parseInt(e.dataset.pstarttime),player=new YT.Player("youtube-player",{height:"100%",width:"100%",videoId:e.dataset.video,playerVars:{autoplay:1},events:{onReady:function(t){videoDuration=t.target.getDuration(),progressInfo2=toTimestamp(t.target.getDuration());var a=readTimeFromUrl();-1!=a&&(t.target.cueVideoById({videoId:e.dataset.video,startSeconds:a}),t.target.playVideo()),updateTimestamp(),setInterval(updateTimestamp,200),loadMarkers(),loadTags(),loadChat()}}})}function loadChat(){var e=document.getElementById("chat"),t=e.dataset.id,a=e.dataset.offset,n=e.dataset.chattype,o=0,r=!1;"full"==a?r=!0:o=parseInt(a),dontShowChatHeader=!0,displayChat(t,e,r,n,o)}function markerColorChange(e,t){var a=document.getElementById("mcol-"+t);a&&(a.style.fill=e.value)}function btnMarkerDiscard(e,t,a){e||(delete markers[t],reloadMarkerList()),rmMarkerElem(e?null:t,a)}function rmMarkerElem(e,t){if(e){var a=document.getElementById("marker-"+e);a&&(a.outerHTML="")}clWindow(t)}function clWindow(e){if(e){var t=document.getElementById(e);t&&(t.outerHTML="")}}function delMarker(e){confirm("Delete marker '"+markers[e].name+"' @ '"+toTimestamp(markers[e].time)+"'?")&&markerDestory(e,t=>{btnMarkerDiscard(!1,e,null)})}function editMarker(e){mkMarkerEditWindow(!0,e,event.clientX+12,event.clientY-12)}function btnMarkerSave(e,a,n){var o=JSON.parse(JSON.stringify(markers[a]));delete o.temp,o.name=document.getElementById("editMarkerName").value.trim(),o.color=document.getElementById("editMarkerColor").value;var r=-1,i=document.getElementById("editMarkerTime").value;if(/^(\d+\:)?(\d+\:)?\d+$/.test(i)){var l=i.split(":").reverse(),s=1,d=0;for(t of l)d+=parseInt(t)*s,s*=60;d<0||d>videoDuration?mkToast("invalid timecode (must be within video time span)!","f55"):r=d}else mkToast("invalid timecode (syntax)! please use hh:mm:ss","f55");-1!=r&&(o.time=r,e?markerUpdate(a,o,e=>{rmMarkerElem(a,n),loadMarkersFromApi(()=>{})}):markerCreate(vidIdMrk,o,e=>{loadMarkersFromApi(()=>{rmMarkerElem(a,n)})}))}function loadMarkersFromApi(e=null){getMarkersVideo(vidIdMrk,t=>{var a={};if(vidIdMrk in t)for(const e of t[vidIdMrk])a[e.id]={color:"#"+e.color,time:e.offset,name:e.text,user:e.by};markers=a,reloadMarkerList(),e&&e()})}function editMarkerKeypress(e,t,a){"Enter"===event.key?btnMarkerSave(e,t,a):"Escape"===event.key&&btnMarkerDiscard(e,t,a)}function loadMarkers(){if(0!=videoDuration){var e=document.getElementsByClassName("discoBoxMarkerC")[0],t=document.createElement("div");t.style.color="white",t.style.background="rgba(0,0,0,0.8)",t.style.padding="5px",t.style.display="none",t.style.position="fixed",t.style.fontSize="smaller",t.innerHTML="click to add a marker",document.body.appendChild(t);var a=document.createElement("div");a.style.background="yellow",a.style.width="1px",a.style.height="32px",a.style.position="absolute",a.style.display="none",a.style.pointerEvents="none",e.style.cursor="pointer",e.addEventListener("mouseleave",e=>{a.style.display="none",t.style.display="none"}),e.addEventListener("click",t=>{if(session){var a=t.clientX,n=e.getBoundingClientRect().left,o=e.getBoundingClientRect().top,r=a-n,i=e.clientWidth,l=r/parseFloat(i);if(l>=0&&l<=1){var s="#"+Math.random().toString(16).substr(2,6);markers.tmp={color:s,time:parseInt(l*videoDuration),name:"(new marker)",user:"local",temp:!0},mkMarkerEditWindow(!1,"tmp",a+10,o+6)}}else showLoginPane("you need to login to create markers")}),e.addEventListener("mousemove",n=>{var o=n.clientX,r=e.getBoundingClientRect().left,i=o-r,l=e.clientWidth,s="";if(i>=0){a.style.display="block";var d=i/parseFloat(l);a.style.left=100*d+"%";var c=parseInt(d*videoDuration);s="click to add a marker at <b>"+toTimestamp(c)+"</b>"}else a.style.display="none";for(var m="",g=n.target,y=null;null!=g;)"markerId"in g.dataset&&(y=g.dataset.markerId),g=g.parentElement;if(null!=y&&y in markers){var p=markers[y];m=colDot(p.color)+" <b>"+toTimestamp(p.time)+"</b>&emsp;"+escapeHtml(p.name)+"<br>"}markerText=m+s,""!=markerText&&(t.innerHTML=markerText,t.style.display="block");var u=t.clientWidth,h=r-12,v=r+l+12-u;t.style.top=e.getBoundingClientRect().bottom+"px";var k=r+i;(k-=u/2)<h&&(k=h),k>v&&(k=v),t.style.left=k+"px"}),e.appendChild(a),chatTabs.innerHTML+='<a id="tabheader-chat" onclick="openTab(\'chat\')" class="active" href="#!">Chat</a>',chatTabs.innerHTML+='<a id="tabheader-markers" onclick="openTab(\'markers\')" href="#!">Markers</a>',(markersPane=document.createElement("div")).style.padding="10px",markersPane.style.display="none",markersPane.innerHTML='<div id="markerlist"></div><br><div id="markersettings" style="diplay: none;"><b>Marker settings</b><br><label><input onclick="toggleMarkers(\'mine\')" checked type="checkbox"></input> show mine</label>&emsp;<label><input onclick="toggleMarkers(\'community\')" checked type="checkbox"></input> show community</label></div>',playerChat.appendChild(markersPane),loadMarkersFromApi()}}markers={};var markersEnabledMine=!0,markersEnabledCommunity=!0;function toggleMarkers(e){"mine"==e?markersEnabledMine=!markersEnabledMine:"community"==e&&(markersEnabledCommunity=!markersEnabledCommunity),reloadMarkerList()}function mkMarkerEditWindow(e,t,a,n){var o="win-edit-marker";rmMarkerElem("tmp",o),e||reloadMarkerList();var r="",i="editMarkerKeypress("+e+", '"+t+"', '"+o+"')",l="btnMarkerSave("+e+", '"+t+"', '"+o+"')",s="btnMarkerDiscard("+e+", '"+t+"', '"+o+"')",d="markerColorChange(this, '"+t+"')";e&&(r=escapeHtml(markers[t].name),d="");var c=markers[t].color,m='<input type="text" id="editMarkerName" placeholder="marker name" value="'+r+'" onkeydown="'+i+'"> ';m+='<button title="[esc]" onclick="'+s+'">&nbsp;x&nbsp;</button><br>',m+='<b>@</b><input type="text" id="editMarkerTime" placeholder="timecode" value="'+toTimestamp(markers[t].time)+'" onkeydown="'+i+'"><br>',m+='<input onchange="'+d+'" style="border:none;padding:0;margin-top:6px;width:16px;height:16px;" type="color" id="editMarkerColor" value="'+c+'"> ',m+='<button title="[enter]" onclick="'+l+'">save</button>',mkWindow(o,a,n,m+='<br><i style="font-size:smaller;opacity:0.6;"><img title="info" src="/media/info.png" height="18px" style="vertical-align:bottom;">markers are public</i>'),document.getElementById("editMarkerName").focus()}function mkWindow(e,t,a,n){var o=document.createElement("div");o.style.color="white",o.style.background="#334455",o.style.border="1px solid #112233",o.style.padding="5px",o.style.display="block",o.style.position="fixed",o.style.top=a+"px",o.style.left=t+"px",o.innerHTML=n,o.id=e,document.body.appendChild(o)}function reloadMarkerList(){var e=document.getElementById("markerlist");if(null!=e){var t=document.getElementsByClassName("discoBoxMarkerC")[0],a=[];for(var n in markers)a.push(n);a.sort((e,t)=>markers[e].time-markers[t].time);var o="";for(var n of a){var r=markers[n],i=r.user==username,l="marker-"+n,s=document.getElementById(l);if(null==s){var d=getNode("svg",{width:20,height:20}),c=getNode("rect",{x:9.142,y:-5,width:10,height:10,transform:"rotate(45)",rx:2,ry:2,fill:r.color,stroke:"black",strokeWidth:2});c.dataset.markerId=n,c.id="mcol-"+n,d.appendChild(c),d.style.position="absolute",d.style.marginLeft="-10px",d.style.top="6px";var m=r.time/parseFloat(videoDuration);d.style.left=100*m+"%",d.id=l,t.appendChild(d),s=d}var g="initial";if(i&&!markersEnabledMine&&(g="none"),i||markersEnabledCommunity||(g="none"),s.style.display=g,!("temp"in r&&r.temp)){var y=escapeHtml(r.name),p="",u=r.user;if(i){if(!markersEnabledMine)continue;p+='<a class="markerEditLink" onclick="editMarker('+n+')" href="#!">edit</a> ',p+='<a class="markerEditLink del" onclick="delMarker('+n+')" href="#!">x</a> ',u='<span title="you" style="color:#47f;">'+u+"</span>"}else if(!markersEnabledCommunity)continue;""==r.name&&(y='<span style="color:#555;">[unnamed]</span>'),o+='<div><a class="timestamp" href="?t='+r.time+'" onclick="return jumpTo('+r.time+');">'+toTimestamp(r.time)+"</a>&ensp;"+colDot(r.color)+"&emsp;"+y+'&emsp;<i style="color:gray;">by '+u+"</i> "+p+"</div>"}}e.innerHTML=o,document.getElementById("markersettings").style.display=session?"block":"none"}}function getNode(e,t){for(var a in e=document.createElementNS("http://www.w3.org/2000/svg",e),t)e.setAttributeNS(null,a.replace(/[A-Z]/g,function(e,t,a,n){return"-"+e.toLowerCase()}),t[a]);return e}function openTab(e){document.getElementById("tabheader-chat").className="",document.getElementById("tabheader-markers").className="";var t=null==chatElement?document.getElementById("chat"):chatElement;"chat"==e?(t.style.display="block",null!=markersPane&&(markersPane.style.display="none"),document.getElementById("tabheader-chat").className="active"):"markers"==e&&(t.style.display="none",null!=markersPane&&(markersPane.style.display="block"),document.getElementById("tabheader-markers").className="active")}var globalCategoryList=[],videoTags=[];function loadTags(){reloadCategoryList(()=>{loadVideoTagsFromApi()})}function loadVideoTagsFromApi(e=null){getTagsVideo(vidId,t=>{videoTags=vidId in t?t[vidId]:[],reloadTagList(),e&&e()})}function reloadCategoryList(e=null){getCategories(t=>{var a={};for(var n in t){var o=t[n];o.color="#"+o.color,a[n]=o}globalCategoryList=a,e&&e()})}function reloadTagList(){var e=document.getElementById("videotags"),t=videoTags;t.sort((e,t)=>{var a=e in globalCategoryList?globalCategoryList[e].count:0;return(t in globalCategoryList?globalCategoryList[t].count:0)-a});var a="";for(var n of t)if(n in globalCategoryList){var o=globalCategoryList[n],r="";session&&(r=' <a class="markerEditLink del" href="#!" onclick="videoUntag('+n+')">x</a>'),a+='<span class="videotag">'+colDot(o.color)+" "+escapeHtml(o.text)+r+"</span> "}e.innerHTML=a+'<span class="videotag add" onclick="videoAddTag()">&nbsp;+&nbsp;</span'}function videoAddTag(){if(session){var e=event.clientX+12,t=event.clientY-12;clWindow("win-add-tag");var a='<input type="text" id="tagSearchField" placeholder="search tags" value="" onkeydown="tagSearchKeypress(false)" onkeyup="tagSearch()"> ';a+='<button title="[esc]" onclick="clWindow(\'win-add-tag\')">&nbsp;x&nbsp;</button><br>',a+='<div id="tagSearchResults" style="max-width: 500px;"></div>',a+='<span style="font-size: smaller;"><a href="#!" class="shade" onclick="showNewTagForm()">Create a new tag</a></span>',mkWindow("win-add-tag",e,t,a+='<br><div id="newTag" style="display:none;"><input type="text" id="newTagName" placeholder="new tag name" value="" onkeydown="tagSearchKeypress(true)"> <input style="border:none;padding:0;width:16px;height:16px;" type="color" id="newTagColor" value="'+("#"+Math.random().toString(16).substr(2,6))+'"> <button onclick="createNewTag()">add</button></div>'),tagSearch(),document.getElementById("tagSearchField").focus()}else showLoginPane("you need to login to add tags")}function tagSearchKeypress(e){if("Enter"===event.key)if(e)createNewTag();else{var t=document.getElementById("tagSearchResults").dataset;if(t.hasOwnProperty("first")){var a=t.first;-1!=a&&videoTag(a)}}else"Escape"===event.key&&clWindow("win-add-tag")}function tagSearch(){var e="",t=document.getElementById("tagSearchField").value.trim(),a=0,n=[];for(var o in globalCategoryList){if(a>=20)break;var r=globalCategoryList[o];""!=t&&-1===r.text.indexOf(t)||(videoTags.includes(parseInt(o))||(n.push({id:o,obj:r}),a++))}n.sort((e,t)=>t.obj.count-e.obj.count);var i=-1;for(res of n){o=res.id;-1==i&&(i=o),e+='<span class="videotag clickable" onclick="videoTag('+o+')" title="click to add">'+colDot((r=res.obj).color)+" "+escapeHtml(r.text)+' <span class="count">'+r.count+"</span></span> "}document.getElementById("tagSearchResults").innerHTML=e,document.getElementById("tagSearchResults").dataset.first=i}function showNewTagForm(){document.getElementById("newTag").style.display="block",document.getElementById("newTagName").value=document.getElementById("tagSearchField").value,document.getElementById("newTagName").focus()}function setTagsVideoAdjustCount(e,t,a,n){setTagsVideo(e,t,a,e=>{t in globalCategoryList&&(globalCategoryList[t].count=e.new_count),n&&n(e)})}function videoTag(e){clWindow("win-add-tag"),videoTags.includes(e)||setTagsVideo(vidId,e,!0,e=>{loadVideoTagsFromApi()})}function videoUntag(e){clWindow("win-add-tag"),setTagsVideoAdjustCount(vidId,e,!1,t=>{loadVideoTagsFromApi(()=>{if(e in globalCategoryList){var t=globalCategoryList[e];0==t.count&&confirm("The tag '"+t.text+"' isn't being used on any video anymore.\nDo you want to delete it now?")&&tagDestroy(e,()=>{reloadCategoryList()})}})})}function createNewTag(){var e=document.getElementById("newTagName").value.trim(),t=document.getElementById("newTagColor").value;0!=e.length?tagCreate(vidId,{name:e,color:t},e=>{clWindow("win-add-tag"),reloadCategoryList(()=>{videoTag(e.id)})}):mkToast("please enter a tag name","f55")}function colDot(e){return'<div style="vertical-align:baseline;display:inline-block;width:10px;height:10px;background:'+e+';border-radius:6px;"></div>'}
var badgeIndex=null,chatTimestampLink="?t=";function renderSingleMessage(e){content="<div>";var t=Math.floor(e.t)-chatOffset;return content+='<a class="timestamp" href="'+chatTimestampLink+t+'" onclick="return jumpTo('+t+');">'+toTimestamp(t)+"</a>&ensp;","twitch"==chatType?(null!=e.b&&null!=badgeIndex&&(null!=e.l&&0==e.l&&(content+='<img title="message was posted after live recording" alt="VOD" src="/media/vodBadge.png"> '),e.b.forEach(e=>{var t=badgeIndex[e.i][e.v];content+='<img title="'+t.title+'" alt="'+t.title+'" src="'+t.img+'"> '})),content+='<a target="_blank" href="https://www.twitch.tv/'+e.n.toLowerCase()+'" style="text-decoration: none; color:#'+(null!=e.s?e.s:"aaa")+';"><b>'+e.n+"</b></a>:&ensp;",e.c.forEach(e=>{null!=e.t?content+=escapeHtml(e.t):null!=e.e?content+='<img title="'+e.a+'" alt="'+e.a+'" src="https://static-cdn.jtvnw.net/emoticons/v1/'+e.e+'/1.0">':null!=e.m&&(content+='<a class="shade" target="_blank" href="https://www.twitch.tv/'+e.m.toLowerCase()+'">@'+e.m+"</a>")})):"mixer"==chatType&&("system"==e.e?content+='<span style="color:#aaa;">'+e.m+"</span>":"c"==e.e&&(content+='<a target="_blank" onclick="return false" href="https://mixer.com/'+e.u.toLowerCase()+'" style="text-decoration: none; color:#'+(null!=e.s?e.s:"37aad5")+';"><b>'+e.u+"</b></a>"+(null==e.a?"":' <span class="mxrUsrLvl">'+e.a+"</span>")+":&ensp;",e.c.forEach(e=>{if("t"==e.t)content+=e.m;else if("@"==e.t)content+='<a class="shade" target="_blank" onclick="return false" href="https://mixer.com/'+e.u.toLowerCase()+'">@'+e.u+"</a>";else if("e"==e.t){var t="";"builtin"==e.s?t="https://mixer.com/_latest/assets/emoticons/"+e.p+".png":"external"==e.s&&(t=e.p),content+='<div class="mxrEmote" alt="'+(null!=e.a?e.a:e.m)+'" style="background-image: url(\''+t+"'); background-position: -"+e.b[0]+"px -"+e.b[1]+"px; width: "+e.b[2]+"px; height: "+e.b[3]+'px;" title="'+e.m+'"></div>'}else"i"==e.t?content+='<img class="mxrImg" alt="'+e.m+'" title="'+e.m+'" src="'+e.i+'">':"a"==e.t&&(content+='<a class="shade" target="_blank" href="'+e.h+'">'+e.m+"</a>")}))),content+="</div>",content}var playerSeek=!1;function jumpTo(e){if(playerSeek)return console.log("seekTo: "+e),player.seekTo(e),!1}var chatElement,chatMessages,numChatMessages,chatType="twitch";function displayChat(e,t,a,s,n=0){chatType=s,load("/comments/"+e+".txt",function(s){if(a&&(chatTimestampLink="/videos/"+e+"?t="),load("/badges/badge_index.txt",function(e){badgeIndex=e;var l=new URL(window.location.href).searchParams.get("vodchat"),o=!1;if(null!=l&&"1"==l&&(o=!0),!a&&o&&null!=document.getElementById("vodChatLbl")&&(document.getElementById("vodChatLbl").innerHTML='<i style="color: #666;">(VOD chat is enabled)</i>'),a)displayChatFull(t,s,o);else{chatElement=t,chatMessages=[];for(var c=0;c<s.length;c++){var r=s[c];(null==r.l||0!=r.l||o)&&chatMessages.push(r)}numChatMessages=chatMessages.length,chatOffset=n,playerSeek=!0,null!=player&&(chatPlayback(),setInterval(chatPlayback,500))}}),a){var l=document.getElementById("topBtn");l.href="/videos/"+e,l.innerHTML="Go to video"}})}var messageIndex,lastSeekPos=-1e3,chatOffset=0,htmlMessages=[],loadBack=100,maxOnScreen=150,numDeleteOnOverflow=20;function chatPlayback(){var e=player.getCurrentTime()+chatOffset;(e<lastSeekPos-.1||e>lastSeekPos+12)&&(messageIndex=initChatAtPoint(e)),lastSeekPos=e;for(var t="";messageIndex<numChatMessages&&chatMessages[messageIndex].t<=e;){var a=renderSingleMessage(chatMessages[messageIndex]);htmlMessages.push(a),t+=a,messageIndex++}if(htmlMessages.length>maxOnScreen){htmlMessages=htmlMessages.slice(numDeleteOnOverflow);for(var s="",n=0;n<htmlMessages.length;n++)s+=htmlMessages[n];chatElement.innerHTML=s,scrollDn()}else""!=t&&(chatElement.innerHTML+=t,scrollDn())}function scrollDn(e=!1){setTimeout(()=>{var t=chatElement.parentElement;t.scrollTop=t.scrollHeight+100,e&&setTimeout(()=>{scrollDn(!1)},50)},5)}var loadAheadSecs=1;function initChatAtPoint(e){for(var t=0,a=numChatMessages;t<a;){var s=Math.floor((t+a)/2);chatMessages[s].t<e+loadAheadSecs?t=s+1:a=s}var n=Math.max(0,t-loadBack),l=chatMessages.slice(n,t);console.log("load "+l.length+" msg ["+n+" "+t+"]"),htmlMessages=[];for(var o="",c=0;c<l.length;c++)if(!(l[c].t-chatOffset<0)){var r=renderSingleMessage(l[c]);htmlMessages.push(r),o+=r}return chatElement.innerHTML=o,scrollDn(!0),t}var dontShowChatHeader=!1;function displayChatFull(e,t,a){var s="";dontShowChatHeader||(s+="<h3>"+(a?"All":"Live")+" chat messages</h3>",a||"twitch"!=chatType||(s+='<a class="shade" href="'+window.location.href+'&vodchat=1">Click here to also include messages posted after the live broadcast</a><br><br>'));for(var n=0,l=0;l<t.length;l++){var o=t[l];(null==o.l||0!=o.l||a)&&(s+=renderSingleMessage(o),n++)}0==n&&(s+='<i style="color: #444;">(no chat messages to display)</i>'),e.innerHTML=s}
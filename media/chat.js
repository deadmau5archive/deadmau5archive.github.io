var chatElement,chatMessages,numChatMessages,messageIndex,badgeIndex=null,chatTimestampLink="?t=";function renderSingleMessage(a){content="<div>";var b=Math.floor(a.t)-chatOffset;return content+='<a class="timestamp" href="'+chatTimestampLink+b+'" onclick="return jumpTo('+b+');">'+toTimestamp(b)+"</a>&ensp;","twitch"==chatType?(void 0!=a.b&&null!=badgeIndex&&(void 0!=a.l&&0==a.l&&(content+='<img title="message was posted after live recording" alt="VOD" src="/media/vodBadge.png"> '),a.b.forEach(b=>{var a=badgeIndex[b.i][b.v];content+='<img title="'+a.title+'" alt="'+a.title+'" src="'+a.img+'"> '})),content+='<a target="_blank" href="https://www.twitch.tv/'+a.n.toLowerCase()+'" style="text-decoration: none; color:#'+(void 0!=a.s?a.s:"aaa")+';"><b>'+a.n+"</b></a>:&ensp;",a.c.forEach(a=>{void 0!=a.t?content+=escapeHtml(a.t):void 0!=a.e?content+='<img title="'+a.a+'" alt="'+a.a+'" src="https://static-cdn.jtvnw.net/emoticons/v1/'+a.e+'/1.0">':void 0!=a.m&&(content+='<a class="shade" target="_blank" href="https://www.twitch.tv/'+a.m.toLowerCase()+'">@'+a.m+"</a>")})):"mixer"==chatType&&("system"==a.e?content+='<span style="color:#aaa;">'+a.m+"</span>":"c"==a.e&&(content+='<a target="_blank" onclick="return false" href="https://mixer.com/'+a.u.toLowerCase()+'" style="text-decoration: none; color:#'+(void 0!=a.s?a.s:"37aad5")+';"><b>'+a.u+"</b></a>"+(void 0==a.a?"":' <span class="mxrUsrLvl">'+a.a+"</span>")+":&ensp;",a.c.forEach(a=>{if("t"==a.t)content+=a.m;else if("@"==a.t)content+='<a class="shade" target="_blank" onclick="return false" href="https://mixer.com/'+a.u.toLowerCase()+'">@'+a.u+"</a>";else if("e"==a.t){var b="";"builtin"==a.s?b="https://mixer.com/_latest/assets/emoticons/"+a.p+".png":"external"==a.s&&(b=a.p),content+='<div class="mxrEmote" alt="'+(void 0!=a.a?a.a:a.m)+'" style="background-image: url(\''+b+"'); background-position: -"+a.b[0]+"px -"+a.b[1]+"px; width: "+a.b[2]+"px; height: "+a.b[3]+'px;" title="'+a.m+'"></div>'}else"i"==a.t?content+='<img class="mxrImg" alt="'+a.m+'" title="'+a.m+'" src="'+a.i+'">':"a"==a.t&&(content+='<a class="shade" target="_blank" href="'+a.h+'">'+a.m+"</a>")}))),content+="</div>"}var playerSeek=!1;function jumpTo(a){if(playerSeek)return console.log("seekTo: "+a),player.seekTo(a),!1}var chatType="twitch";function displayChat(a,c,d,b,e=0){chatType=b,load("/comments/"+a+".txt",function(f){if(d&&(chatTimestampLink="/videos/"+a+"?t="),load("/data/badges.json",function(i){badgeIndex=i;var h=new URL(window.location.href).searchParams.get("vodchat"),a=!1;if(null!=h&&"1"==h&&(a=!0),!d&&a&&null!=document.getElementById("vodChatLbl")&&(document.getElementById("vodChatLbl").innerHTML='<i style="color: #666;">(VOD chat is enabled)</i>'),d)displayChatFull(c,f,a);else{chatElement=c,chatMessages=[];for(var b=0;b<f.length;b++){var g=f[b];(void 0==g.l||0!=g.l||a)&&chatMessages.push(g)}numChatMessages=chatMessages.length,chatOffset=e,playerSeek=!0,null!=player&&(chatPlayback(),setInterval(chatPlayback,500))}}),d){var b=document.getElementById("topBtn");b.href="/videos/"+a,b.innerHTML="Go to video"}})}var lastSeekPos=-1e3,chatOffset=0,htmlMessages=[],loadBack=100,maxOnScreen=150,numDeleteOnOverflow=20;function chatPlayback(){var a=player.getCurrentTime()+chatOffset;(a<lastSeekPos-.1||a>lastSeekPos+12)&&(messageIndex=initChatAtPoint(a)),lastSeekPos=a;for(var b="";messageIndex<numChatMessages&&chatMessages[messageIndex].t<=a;){var d=renderSingleMessage(chatMessages[messageIndex]);htmlMessages.push(d),b+=d,messageIndex++}if(htmlMessages.length>maxOnScreen){htmlMessages=htmlMessages.slice(numDeleteOnOverflow);for(var e="",c=0;c<htmlMessages.length;c++)e+=htmlMessages[c];chatElement.innerHTML=e,scrollDn()}else""!=b&&(chatElement.innerHTML+=b,scrollDn())}function scrollDn(a=!1){setTimeout(()=>{var b=chatElement.parentElement;b.scrollTop=b.scrollHeight+100,a&&setTimeout(()=>{scrollDn(!1)},50)},5)}var loadAheadSecs=1;function initChatAtPoint(i){for(var a=0,d=numChatMessages;a<d;){var e=Math.floor((a+d)/2);chatMessages[e].t<i+loadAheadSecs?a=e+1:d=e}var f=Math.max(0,a-loadBack),b=chatMessages.slice(f,a);console.log("load "+b.length+" msg ["+f+" "+a+"]"),htmlMessages=[];for(var g="",c=0;c<b.length;c++)if(!(b[c].t-chatOffset<0)){var h=renderSingleMessage(b[c]);htmlMessages.push(h),g+=h}return chatElement.innerHTML=g,scrollDn(!0),a}var dontShowChatHeader=!1;function displayChatFull(g,e,b){var a="";dontShowChatHeader||(a+="<h3>"+(b?"All":"Live")+" chat messages</h3>",b||"twitch"!=chatType||(a+='<a class="shade" href="'+window.location.href+'&vodchat=1">Click here to also include messages posted after the live broadcast</a><br><br>'));for(var f=0,c=0;c<e.length;c++){var d=e[c];(void 0==d.l||0!=d.l||b)&&(a+=renderSingleMessage(d),f++)}0==f&&(a+='<i style="color: #444;">(no chat messages to display)</i>'),g.innerHTML=a}
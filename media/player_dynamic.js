var videoResponse,videoObject,videoPart,paramId,paramCue,paramEdition,player,playerContainer,boundingRect,playerChat,vidId,theatreModeToggleBtn,descBarToggleBtn,descBarToggleBtn2,videoBox,navBox,descBox,timelineBox,progressInfo,localTimeInfo,videoStartTime,chatTabs,markersPane,vidIdMrk,vSigValue,cplayer,providers,onedrivePlayerEmbed,paramPart=0,isMultipart=!1,progressInfo2=null,progressInfoVidDurationFormatted="",progressInfoStreamDurationFormatted="",videoDuration=0,nPartId=0,nPartNum=0,hasChat=!1,externalAudio=null,externalAudioEnabled=!1,audioPlayerMode=!1,providerTypeForId={},preferredProvider=null,providerData={},partOffset=0;function loadPageContent(e){if(void 0!==videoObject){var a="title"in videoObject&&null!=videoObject.title?escapeHtml(videoObject.title):'<i style="opactiy:0.5;" title="no original title">deadmau5 livestream</i>',r="game"in videoObject&&null!=videoObject.game?escapeHtml(videoObject.game):'<span title="no category">--</span>';document.getElementById("desc_title").innerHTML=(isMultipart?'<span class="partLbl">Part '+(paramPart+1)+" of "+nPartNum+"</span>&ensp;":"")+a,document.getElementById("desc_game").innerHTML=r;var i="";if("isTimeApprox"in videoObject&&videoObject.isTimeApprox&&(i='<span title="approx.">~</span>'),"formattedTime"in videoObject){var o=videoObject.formattedTime,n=o.date_str+"&emsp;"+i+o.time_str;"tz_str"in o&&(n+=" "+o.tz_str),document.getElementById("desc_time_et").innerHTML=n}if("formattedTimeUTC"in videoObject){var o=videoObject.formattedTimeUTC,n=o.date_str+"&emsp;"+i+o.time_str;"tz_str"in o&&(n+=" "+o.tz_str),document.getElementById("desc_time_utc").innerHTML=n}stSource="","twitch"==videoObject.type?stSource+='<img src="/media/twitch.png"> Twitch':"mixer"==videoObject.type?stSource+='<img src="/media/mixer.png"> Mixer':"mau5trap.tv"==videoObject.type&&(stSource='<img src="/media/favicon.png"> mau5trap.tv'),"streamNumber"in videoObject&&null!=videoObject.streamNumber&&(stSource+=' <b title="Stream Number\n\nthis is more of an approximative quantity than a fixed number. it means as much as: this is the N-th recorded stream on the archive for this platform. it does NOT mean that this was necessarily exactly the N-th stream on that platform!">#'+videoObject.streamNumber+"</b>"),document.getElementById("desc_source").innerHTML=stSource,progressInfoStreamDurationFormatted=toTimestamp(videoObject.length),hasChat="hasChat"in videoObject&&!0===videoObject.hasChat;var l="";if("youtube"==providerTypeForId[preferredProvider]&&isMultipart){partLinkList="";for(var s=0;s<nPartNum;s++)partLinkList+='<a href="/videos?v='+paramId+"&f="+preferredProvider+"&p="+(s+1)+'" class="btn">Part '+(s+1)+"</a> ";l+='<div class="partInfo"><div><img src="/media/info.png" class="infoIcon" /> <b>This stream has multiple parts!</b><br><i>Currently watching: Part '+(paramPart+1)+'</i><br><span class="partLinks">'+partLinkList+"</span></div></div>"}if("info"in e)for(var d of e.info)"length_mismatch"==d.type?l+='<div class="partInfo"><div><img src="/media/length.png" class="infoIcon" /> <b>The length of this video does not match the length of the original VOD.</b>&emsp;<span style="color: #555;">('+d.data.diff+' seconds difference)</span><br><i>This most likely happened because there was an empty section in the VOD that then got removed when converting. So no actual content should be missing. If you do find a problem, please use the report problem link below. Thanks!<br><span style="color: #ff8b08;">This does however mean that chat and link timestamps for this video after a certain point are incorrect.</span></i></div></div>':"missing_start"==d.type?l+='<div class="partInfo"><div><img src="/media/length.png" class="infoIcon" /> <b>Missing start</b><br>The stream recording started late, therefore the beginning of this stream is missing.</div></div>':"missing_end"==d.type?l+='<div class="partInfo"><div><img src="/media/length.png" class="infoIcon" /> <b>Missing end</b><br>The stream recording ended before the stream ended, therefore the end of this stream is missing.</div></div>':"manual_recording"==d.type&&(l+='<div class="partInfo"><div> \uD83D\uDDA5️\uD83C\uDFA5 <b>Manual recording</b><br>This stream recording was done manually by using screen recording software.<br><i>This means that sometimes UI elements from the recording system might pop up, the stream might go out of frame or you see some user interaction with the system. Sorry about that.</i></div></div>');if("youtube"==providerTypeForId[preferredProvider]){if("unblocked"==paramEdition||"editionAltIds"in videoPart&&videoPart.editionAltIds.includes("unblocked"))l+='<div class="partInfo"><div> <img src="/media/info.png" class="infoIcon" /> <b>This is an unblocked version of this video.</b><br><i>Some audio has been muted to prevent a block in certain countries. You can try to watch the original version with less mutes, but it might not be available in your area:</i><br><a href="/videos/?v='+paramId+"&f="+preferredProvider+(isMultipart?"&p="+(paramPart+1):"")+'" class="btn">Normal version</a> </div></div>';else{var c=!1;for(var p of videoPart.editions)if("editionAltIds"in p&&p.editionAltIds.includes("unblocked")){c=!0;break}c&&(l+='<div class="partInfo"><div> <img src="/media/ytb-some.png" class="infoIcon" /> <b>This video might be blocked in some countries.</b><br><i>If you cannot play the video above, try this unblocked version where some copyrighted audio was removed:</i><br><a href="/videos/?v='+paramId+"&f="+preferredProvider+(isMultipart?"&p="+(paramPart+1):"")+'&e=unblocked" class="btn">Unblocked version</a> </div></div>')}}if("youtube"==providerTypeForId[preferredProvider]&&videoPart.editions.length>1){for(var p of(l+='<div class="partInfo"><div>',l+='<h3 style="display:inline;">Edition selection</h3>&ensp;<a class="shade" href="#!" style="font-size:smaller;opacity:0.4;display:inline-block;transform:translateY(-2px);" onclick="infoPopup(\'editions\')"><i>(?)</i></a><div><table class="editionsTable">',videoPart.editions)){var m=p.editionId==videoPart.editionId;l+='<tr class="'+(p.editionInfo.flags.includes("superseded")?"faint":"")+" "+(m?"current":"")+'" onclick="playEdition(\''+p.editionId+"');\">",l+='<td title="'+p.editionId+'">'+(null!=p.editionInfo.title?p.editionInfo.title:'<span style="opacity:0.2;">&mdash;</span>')+"</td>";var v=p.editionInfo.branch+" v"+p.editionInfo.version_number,u="<i>#"+(p.editionInfo.version_number+1)+"</i>",g="?",y="?";"ROOT"==p.editionInfo.branch?(g="O",y="original"):"MUTES_GLOBAL"==p.editionInfo.branch?(g="G",y="global mutes"):"MUTES_GLOBAL_REGIONAL"==p.editionInfo.branch?(g="GR",y="global and regional mutes"):"VISUAL"==p.editionInfo.branch&&(g="V",y="visual only"),l+='<td title="'+v+'"><span title="edition branch: '+y+'" style="border: 1px solid #888; border-radius:3px;">'+g+"</span> "+u+"</td>";var b="",h=p.editionInfo.flags;h.includes("no_info")&&(b+='<span class="edFlag" title="no information about removed content available" style="color:#fff;background:#aaa;">?</span> '),h.includes("global_mutes")&&(b+='<span class="edFlag" title="content removed to prevent global block" style="color:#fff;background:#f00;">G</span> '),h.includes("regional_mutes")&&(b+='<span class="edFlag" title="content removed to prevent regional block" style="color:#fff;background:#f80;">R</span> '),h.includes("blur")&&(b+='<span class="edFlag" title="visual content removed (blur)" style="color:#fff;background:#888;">V</span> '),h.includes("regional_blocks")&&(b+='<img title="regionally blocked version" src="/media/ytb-some.png"> '),h.includes("visual_only")&&(b+='<span class="edFlag" style="color:#fff;background:#00f;" title="visual only">&#128065;</span> '),h.includes("superseded")&&(b+='<span class="edFlag" style="color:#fff;background:#000;" title="old video edition (superseded by newer version)">✝</span> '),l+="<td>"+b+"</td>";var f="";for(var $ of p.editionInfo.mute_info){var k="[";"audio"==$.type?k+='<img src="/media/mute.png">':"visual"==$.type&&(k+='<img src="/media/not_visible.png">'),k+=""+$.count+"] "+toTimestamp($.time_total,!1)+" ",k+=""+Math.round(100*$.time_total/videoPart.length)+"%",f+=k+" "}l+='<td title="number of removed sections, total removed time, approx. percentage of video removed">'+f+"</td>";var T=p.editionInfo.yt_state.availability,I=p.editionInfo.yt_state.last_updated>0?" [last checked: "+new Date(1e3*p.editionInfo.yt_state.last_updated).toISOString().substring(0,10)+"]":"",x="",w="";"unknown"==T?(x="unknown",w="ytb-unknown"):"available"==T?(x="available",w="ytb-available"):"regionally_blocked"==T?(x="regionally blocked",w="ytb-some"):"blocked"==T&&(x="blocked",w="ytb-all"),l+='<td><img title="YouTube video availability: '+x+I+'" alt="'+T+'" src="/media/'+w+'.png"></img></td>',l+="</tr>"}l+="</table></div></div></div>"}document.getElementById("partInfoContainer").innerHTML+=l;var B='<b>Community tags</b> (public)<br> <div id="videotags"></div> <br>',_="";for(var E of[{field:"muted",desctitle:"<b>Muted segments:</b>",background:"rgba(212,73,73,0.9)"},{field:"unmuted",desctitle:"<b>Unmuted segments:</b>",background:"#8fa"}])if(E.field in videoObject&&videoObject[E.field].length>0){var P=[];for(var C of videoObject[E.field]){var M=C[0],L=C[1],O=videoObject.length;if("youtube"!=providerTypeForId[preferredProvider]||(M-=partOffset,L-=partOffset,O=videoPart.length,!(M<0)&&!(L>O))){var D=L-M,j=M/O,S=D/O;_+='<div class="tlmuteseg" style="background: '+E.background+"; left: "+100*j+"%; width: "+100*S+'%;"></div>',P.push('<a class="shade" href="?v='+paramId+(isMultipart?"&p="+(nPartId+1):"")+"&t="+M+'" onclick="return jumpTo('+M+');">'+toTimestamp(M)+'</a> - <a class="shade" href="?v='+paramId+(isMultipart?"&p="+(nPartId+1):"")+"&t="+L+'" onclick="return jumpTo('+L+');">'+toTimestamp(L)+"</a>")}}B+=E.desctitle+"&emsp;"+P.join("&ensp;")+"<br><br>"}if("discontinuity"in videoObject&&videoObject.discontinuity.length>0){var F="",H=[];for(var A of videoObject.discontinuity){var O=videoObject.length;("youtube"!=providerTypeForId[preferredProvider]||(A-=partOffset,O=videoPart.length,!(A<0)&&!(A>O)))&&(F+='<div class="tlDiscoMarker" style="left: '+100*(A/O)+'%;"></div>',H.push('<a class="shade" href="?v='+paramId+(isMultipart?"&p="+(nPartId+1):"")+"&t="+A+'" onclick="return jumpTo('+A+');">'+toTimestamp(A)+"</a>"))}document.getElementById("tl_markers").innerHTML=F,B+="<b>Discontinuity:</b>&emsp;"+H.join("&ensp;")+"<br><br>"}if("youtube"==providerTypeForId[preferredProvider]){for(var N of[{field:"contentid_removed",desctitle:"<b>Content removed to prevent YouTube block:</b>",background:"#ff3"},{field:"contentid_matched",desctitle:"<b>Content in this video</b> (recognized via YouTube Content ID):",background:"rgba(255,255,255,0.45)"}])if(N.field in videoPart&&videoPart[N.field].length>0){var V=[];for(var U of videoPart[N.field]){var M=U.t[0],L=U.t[1],D=L-M,j=M/videoPart.length,S=D/videoPart.length;_+='<div class="tlmuteseg" style="background: '+N.background+"; left: "+100*j+"%; width: "+100*S+'%;"></div>';var W="???";"text"in U&&null!==U.text?W=U.text:("title"in U&&null!==U.title&&(W=U.title),"artist"in U&&null!==U.artist&&(W+=" - "+U.artist),"label"in U&&null!==U.label&&(W+=" ("+U.label+")")),listingType="",U.av.includes("a")&&(listingType+="&#127926;"),U.av.includes("v")&&(listingType+="&#128065;");var R=listingType+' <a class="shade" href="?v='+paramId+(isMultipart?"&p="+(nPartId+1):"")+"&t="+M+'" onclick="return jumpTo('+M+');">'+toTimestamp(M)+'</a> - <a class="shade" href="?v='+paramId+(isMultipart?"&p="+(nPartId+1):"")+"&t="+L+'" onclick="return jumpTo('+L+');">'+toTimestamp(L)+"</a>&ensp;"+W;V.push(R)}B+=N.desctitle+"<br>"+V.join("<br>")+"<br><br>"}}B+='<div class="links">',"youtube"==providerTypeForId[preferredProvider]&&"ytid"in e&&null!=e.ytid?B+='<a href="https://www.youtube.com/watch?v='+e.ytid+'" target="_blank" class="btn"><img src="/media/yt.png" class="icon"> Watch on YouTube</a> ':"onedrive"==providerTypeForId[preferredProvider]&&"watch_url"in e&&null!=e.watch_url?B+='<a href="'+e.watch_url+'" target="_blank" class="btn"><img src="/media/onedrive.png" class="icon"> Watch on OneDrive</a> ':"audio"==providerTypeForId[preferredProvider]&&"watch_url"in e&&null!=e.watch_url&&(B+='<a href="'+e.watch_url+'" target="_blank" class="btn"><img src="/media/onedrive.png" class="icon"> Open on OneDrive</a> '),videoObject.originalAvailable&&"twitch"==videoObject.type&&(B+='<a href="https://www.twitch.tv/videos/'+paramId+'" target="_blank" class="btn"><img src="/media/twitch.png" class="icon"> Watch on Twitch (original)</a> '),B+="</div>";var z=[];if("hlsUrls"in videoObject&&z.push('<a href="#!" onclick="showHlsUrls()" class="shade">HLS playlist links (m3u8)</a>'),z.push('<a href="/chat?v='+paramId+'" class="shade">\uD83D\uDCAC Full chat log</a>'),"twitch"==videoObject.type&&z.push('<span id="vodChatLbl"><a href="?v='+paramId+(isMultipart?"&p="+(nPartId+1):"")+'&vodchat=1" class="shade">Include VOD chat</a></span>'),z.push('<a target="_blank" href="https://docs.google.com/forms/d/e/1FAIpQLSfs60U7bxaLJcsJs3UnFJlzmdWNZ-3NRXgRdOZse_0apDhM9Q/viewform?entry.454230727='+paramId+'" class="shade"> <img src="/media/report.png" class="icon">Report a problem with this video </a>'),B+=z.join(" &emsp; "),"hlsUrls"in videoObject){var Y="";for(var G in videoObject.hlsUrls){var J=videoObject.hlsUrls[G];Y+="<b>"+G+'</b>: <a href="'+J+'" target="_blank" class="shade">'+escapeHtml(J)+"</a> <br>"}Y+='<br><a href="#!" onclick="infoPopup(\'about-hlsurls\')" class="shade" style="opacity: 0.6;"><i>(What is this?)</i></a>',B+='<br><div id="hlsurls_container" style="display:none;"><br>'+Y+"</div>"}""!=_&&(document.getElementById("tl_sections").innerHTML=_),document.getElementById("desc_post").innerHTML=B}}function loadExternalAudio(){if("youtube"==providerTypeForId[preferredProvider]&&"external_audio"in videoSubObj){nPartNum>1&&alert("information: youtube + external audio sync player does not support multiple parts yet.");var e=function(e){var a=document.createElement("div");a.id="external_audio",a.className="exta-box",document.getElementById("subTimelineBox").appendChild(a),a.innerHTML='<div class="exta-prog-container"><div id="externalAudioProgress" class="exta-prog exta-prog-loading"><div id="externalAudioProgressIndicator" style="width:0%"></div></div></div><div class="exta-title">EXTERNAL AUDIO</div> <div class="exta-volume">\uD83D\uDD0A <input id="externalAudioVolume" type="range" min="0" max="1" step="any" value="1"></div><div class="exta-time" id="externalAudioProgressTime">loading...</div>';var r=document.getElementById("externalAudioProgressIndicator"),i=document.getElementById("externalAudioProgressTime");document.getElementById("externalAudioProgress").addEventListener("click",e=>{infoPopup("ytsync-audio-seek")});var o=new Audio(e),n=!1;o.addEventListener("canplaythrough",e=>{n||(n=!0,document.getElementById("externalAudioProgress").classList.remove("exta-prog-loading"),i.textContent="00:00:00")});var l=document.createElement("div");l.id="clickPlayBox",l.style.position="absolute",l.style.top="0px",l.style.left="0px",l.style.width="100%",l.style.height="100%",l.style.zIndex="9999",l.style.background="rgba(0,0,0,0.9)",l.addEventListener("click",e=>{player&&(player.mute(),player.playVideo()),l.remove()}),l.innerHTML='<img src="/media/play.png" style="position:absolute;top:50%;left:50%;transform:translate(-25px,-25px)"></img><div style="color:white;position:absolute;top:50%;left:50%;transform:translate(-100px,30px);width:200px;text-align:center;">click here to play</div>',l.title="you need to click this first (to allow the external audio to play)",document.getElementById("playerContainer").appendChild(l),document.getElementById("externalAudioVolume").addEventListener("input",e=>{o.volume=e.target.value,o.muted=0===e.target.value}),o.addEventListener("volumechange",()=>{setCookie("external_audio_volume",JSON.stringify({volume:o.volume,muted:o.muted}))}),o.addEventListener("timeupdate",()=>{n&&(i.textContent=toTimestamp(o.currentTime));let e=o.currentTime/o.duration;r.style.width=100*e+"%"});var s=getCookie("external_audio_volume");null!==s&&("volume"in(s=JSON.parse(s))&&(o.volume=s.volume),"muted"in s&&(o.muted=s.muted),document.getElementById("externalAudioVolume").value=o.volume),setInterval(()=>{if(player&&void 0!==player.getCurrentTime){var e=player.getCurrentTime(),a=o.currentTime;!isNaN(e)&&!isNaN(a)&&Math.abs(e-a)>.2&&(o.currentTime=e)}},100),externalAudio=o};resolveUrlOrUrlDynamic(videoSubObj.external_audio,e),externalAudioEnabled=!0}}function resolveUrlOrUrlDynamic(e,a){"url"in e?a(e.url):"url_dynamic"in e&&getPlaybackUrl(paramId,e.url_dynamic,e=>{a(e.playback_url)})}function showHlsUrls(){document.getElementById("hlsurls_container").style.display="block",document.getElementById("hlsurls_container").scrollIntoView()}function playEdition(e){var a="";"youtube"==providerTypeForId[preferredProvider]&&(a="&f="+preferredProvider),window.location.href="/videos/?v="+paramId+a+(isMultipart?"&p="+(paramPart+1):"")+"&e="+e}function infoPopup(e){var a="";"about-hlsurls"==e?a='These are links to <a class="shade" href="https://en.wikipedia.org/wiki/M3U" target="_blank">HLS playlist</a> files <i>(HLS = HTTP Live Streaming)</i> that Twitch uses to host VODs.<br>Basically, Twitch cuts up videos in small chunks and these links point to text files that contain information where to find all these chunks.<br>This is the resource the Twitch player uses to play your VOD. But you can use any other player that supports HLS.<br><i>For example:</i> In VLC media player, go to Media &#9654; Open Network Stream (Ctrl + N) and put one of the HLS URLs in there. It will play your video, directly from Twitch\'s VOD servers.':"why-discord"==e?a="access control is handled via discord <br> roles you have on the discord server correspond to user groups on this site":"editions"==e?a="This video has multiple editions. Select which one you want to play.<br>Some editions may be blocked on youtube, others may have muted sections to prevent blocks.":"ytsync-audio-seek"==e&&(a="please use the video player above to seek. the audio playback position will sync automatically."),a="<b>Info</b> <button onclick=\"clWindow('info-popup')\">&nbsp;x&nbsp;</button><br><br>"+a;var r=event.clientX+12,i=event.clientY-12;clWindow("info-popup"),mkWindow("info-popup",r,i,a)}function reloadTagAndMarkerList(){reloadMarkerList(),reloadTagList()}function loadProviderData(){if(videoSubObj=null,"youtube"==providerTypeForId[preferredProvider]){var e=providerData[preferredProvider];videoPart=e.parts[paramPart],isMultipart=e.parts.length>1;var a=null;"defaultEdition"in videoPart?a=videoPart.defaultEdition:videoPart.editions.length>=1&&(a=videoPart.editions[0].editionId);var r=[],i={};for(var o of videoPart.editions)for(var n of(r.push(o.editionId),i[o.editionId]=o,o.editionAltIds))r.push(n),i[n]=o;if(null!=paramEdition&&r.includes(paramEdition)&&(a=paramEdition),null!=a){var l=i[a];for(var s in l)videoPart[s]=l[s]}nPartId=paramPart,nPartNum=e.parts.length,videoStartTime=videoPart.timestamp,videoDuration=videoPart.length,partOffset=videoPart.start,videoSubObj=videoPart}else"onedrive"==providerTypeForId[preferredProvider]?videoSubObj=providerData[preferredProvider].video:"hls"==providerTypeForId[preferredProvider]?videoSubObj=providerData[preferredProvider].stream:"audio"==providerTypeForId[preferredProvider]&&(videoSubObj=providerData[preferredProvider].audio);return videoSubObj}function initPage(){if("mixer"==videoObject.type){var e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.href="/media/style_mixer.css",document.head.appendChild(e)}vidId=paramId,vSigValue=videoObject.vsig,videoStartTime=videoObject.timestamp,videoDuration=videoObject.length;var a=loadProviderData(),r=a.state,i=!1;if("uploaded"==r)i=!0;else if("abandoned_processing"==r)document.getElementById("playerbox_abandoned").style.display="block",videoObject.originalAvailable&&(document.getElementById("abandoned_original").style.display="inline");else if("not_yet_uploaded"==r)document.getElementById("playerbox_notuploaded").style.display="block";else if("no_recording"==r)document.getElementById("playerbox_norecording").style.display="block";else if("access_restricted"==r){if("access_control"in videoResponse){var o=videoResponse.access_control;if(o.granted){i=!0;var n=o.groups[0];document.getElementById("partInfoContainer").innerHTML+='<div class="partInfoPlain"><b style="color:#0a0;">\uD83D\uDD13 access restricted video &mdash; access granted to <span style="color:#fff;">'+username+'</span> with privilege <span style="color:#'+n.color+';">'+escapeHtml(n.name)+"</span></b> </div>"}else{document.getElementById("accessrestriction_state_login").innerHTML=o.gate.login?"✔️":"❌",document.getElementById("accessrestriction_state_connection").innerHTML=o.gate.account_connected?"✔️":"❌",document.getElementById("accessrestriction_state_group").innerHTML=o.gate.group_member?"✔️":"❌",o.gate.login&&(document.getElementById("accessrestriction_helplinks_login").style.display="none"),o.gate.account_connected&&(document.getElementById("accessrestriction_helplinks_connection").style.display="none");var l="";for(var n of o.groups)l+='<span style="display: inline-block; padding:5px 10px; border-radius: 20px; border: 1px solid #'+n.color+';">'+escapeHtml(n.name)+"</span> ";document.getElementById("accessrestriction_group_list").innerHTML=l,document.getElementById("playerbox_accessrestriction").style.display="block"}}else document.getElementById("playerbox_error").style.display="block",document.getElementById("video_error_text").innerHTML="error: access restricted but no access control response"}else document.getElementById("playerbox_error").style.display="block",document.getElementById("video_error_text").innerHTML="error: unknown state";postInit(i,a)}function postInit(e,a){loadPageContent(a);var r=!1;for(var i of(e&&("youtube"==providerTypeForId[preferredProvider]?(loadExternalAudio(),loadYtPlayer(a.ytid),r=!0):"onedrive"==providerTypeForId[preferredProvider]?(loadOneDrivePlayer(a),r=!0):"hls"==providerTypeForId[preferredProvider]?(loadCustomPlayerHls(a),r=!0):"audio"==providerTypeForId[preferredProvider]&&loadCustomPlayerAudio(a)),reloadTagAndMarkerList(),playerContainer=document.getElementById("playerContainer"),videoBox=document.getElementById("videoBox"),navBox=document.getElementsByClassName("navbox")[0],playerChat=document.getElementById("player_chat"),timelineBox=document.getElementsByClassName("videoTimelineInfoBox")[0],vidIdMrk=vidId,descBox=document.getElementById("desc"),(descBoxBtns=document.createElement("div")).id="descBtns",descBox.appendChild(descBoxBtns),["timeline","waveform","spectrogram"]))("timeline"!=i||"hasTimeline"in videoObject&&!0==videoObject.hasTimeline)&&("waveform"!=i||"hasWaveform"in videoObject&&!0==videoObject.hasWaveform)&&("spectrogram"!=i||"hasSpectrogram"in videoObject&&!0==videoObject.hasSpectrogram)&&((genericDescBoxBtn=document.createElement("div")).className="descBtn",genericDescBoxBtn.innerHTML="<div onclick=\"toggleSubTimeline(this,'"+i+'\')"><img src="/media/toggle-'+i+'.png" class="icon"></div>',descBoxBtns.appendChild(genericDescBoxBtn));(descBarToggleBtn=document.createElement("div")).className="descBtn",descBarToggleBtn.innerHTML='<div onclick="toggleDescBar()"><img src="/media/descbtn.png" class="icon"></div>',descBoxBtns.appendChild(descBarToggleBtn),(descBarToggleBtn2=document.createElement("div")).className="descBtn",descBarToggleBtn2.innerHTML='<div onclick="toggleDescBar()"><img src="/media/descbtn2.png" class="icon"></div>',descBarToggleBtn2.style.top="20px",descBarToggleBtn2.style.right="28px",descBarToggleBtn2.style.zIndex="1",descBarToggleBtn2.style.display="none",descBarToggleBtn2.style.position="absolute",(descBarToggleBtn2Cnt=document.createElement("div")).style.position="relative",descBarToggleBtn2Cnt.style.width="100%",descBarToggleBtn2Cnt.style.height=0,descBarToggleBtn2Cnt.appendChild(descBarToggleBtn2),videoBox.appendChild(descBarToggleBtn2Cnt),(theatreModeToggleBtn=document.createElement("div")).setAttribute("id","toggleTheatreBtn"),theatreModeToggleBtn.className="descBtn",theatreModeToggleBtn.innerHTML='<div onclick="toggleTheatre()"><img src="/media/theatre.png" class="icon"></div>',r&&descBoxBtns.appendChild(theatreModeToggleBtn);var o=10;(progressInfoC=document.createElement("div")).className="descRight",progressInfoC.innerHTML=isMultipart?'<b title="part progress">P</b> ':"",progressInfoC.style.top=o+"px",(progressInfo=document.createElement("span")).innerHTML="--:--:-- / --:--:--",progressInfoC.appendChild(progressInfo),descBox.appendChild(progressInfoC),o+=18,isMultipart&&((progressInfo2C=document.createElement("div")).className="descRight",progressInfo2C.innerHTML='<b title="stream progress">S</b> ',progressInfo2C.style.top=o+"px",progressInfo2C.style.opacity="0.6",(progressInfo2=document.createElement("span")).innerHTML="--:--:-- / --:--:--",progressInfo2C.appendChild(progressInfo2),descBox.appendChild(progressInfo2C),o+=18),(localTimeInfo=document.createElement("div")).className="descRight localTime",localTimeInfo.title="JoelTime™",localTimeInfo.innerHTML="--:--",localTimeInfo.style.display="none",localTimeInfo.style.top=o+"px",localTimeInfo.onclick=function(){timeFormat24h=!timeFormat24h,updateTimestampYt(),updateTimestampCustom()},descBox.appendChild(localTimeInfo),chatTabs=document.getElementById("chat_tabs"),recalculateSizes(),window.onresize=function(){recalculateSizes()};var n=document.getElementById("prevNextLinks");getVideoContext(paramId,e=>{var a=e.total_count,r=e.video_index+1,i=e.previous_id,o=e.next_id,l="",s="";null!=i&&(l='<a href="/videos?v='+i+'" class="btn">&#9664; Previous</a>'),null!=o&&(s='<a href="/videos?v='+o+'" class="btn">Next &#9654;</a>'),n.innerHTML=l+" &emsp; <b>"+r+" / "+a+"</b> &emsp; "+s,n.title="video number in archive catalog"})}window.addEventListener("load",function(e){var a=new URL(window.location.href),r=a.searchParams.get("v");null!=r?(r=r.trim(),waitforSession(()=>{getVideo(r,e=>{if(videoObject=(videoResponse=e).video_data,paramId=r,"found"in videoResponse){var i=videoResponse.found,o="/videos?v="+i.video_id;"part"in i&&(o+="&p="+i.part),"edition"in i&&(o+="&e="+i.edition),"provider"in i&&(o+="&f="+i.provider),window.location.href=o;return}if(null==videoObject){document.getElementById("playerbox_notfound").style.display="block";return}var n=document.getElementById("provider_tabs"),l=[],s={};for(var d of providers=videoObject.providers)l.push(d.id),providerData[d.id]=d.providerData,n.innerHTML+='<a id="pr-tab-'+d.id+'" href="?v='+paramId+"&f="+d.id+'">'+d.displayName+"</a>",!("noDefault"in d&&d.noDefault)&&(null==preferredProvider&&(preferredProvider=d.id),"typeDefault"in d&&d.typeDefault&&(s[d.type]=d.id)),providerTypeForId[d.id]=d.type;if(n.innerHTML+='<a class="tabInformational" href="#!" onclick="embedHelp()"><img src="/media/info_blue.png">embed not working?</a>',0==l.length){document.getElementById("playerbox_error").style.display="block",document.getElementById("video_error_text").innerHTML="error: no providers";return}null==preferredProvider&&(preferredProvider=l[0]);var c=!1,p=a.searchParams.get("f");null!=p&&(p=p.trim(),l.includes(p)&&(preferredProvider=p,c=!0));var m=a.searchParams.get("t"),v=readTimeFromUrl();-1!=v&&(paramCue=v);var u=a.searchParams.get("p");if(null!=u&&/^\d+$/.test(u)){var g=null,y=null;if("youtube"==providerTypeForId[preferredProvider]?g=preferredProvider:!c&&"youtube"in s&&(y=g=s.youtube),null!=g){var b=providerData[g],h=parseInt(u)-1;h>=0&&h<b.parts.length&&(paramPart=h,null!=y&&(preferredProvider=g))}}var f=a.searchParams.get("e");if(null!=f&&(paramEdition=f.trim()),document.getElementById("pr-tab-"+preferredProvider).classList.add("active"),"youtube"==providerTypeForId[preferredProvider]&&0==paramPart&&-1!=v){for(var $=0,k=0,b=providerData[preferredProvider],T=0;T<b.parts.length;T++){var I=b.parts[T];if(v>=I.start&&v<I.start+I.length){$=T,k=v-I.start;break}}if($>0){a.searchParams.set("v",paramId),a.searchParams.set("f",preferredProvider),a.searchParams.set("p",$+1),a.searchParams.set("t",k),a.searchParams.set("ot",m),window.location.href=a.toString();return}}initPage()})})):window.location.href="/page?p=1"});var timeFormat24h=!0;function updateTimestampYt(){null==player||isNaN(player.getCurrentTime())||updateTimestamp(player.getCurrentTime())}function updateTimestampCustom(){null==cplayer||isNaN(cplayer.getPlaybackPos())||updateTimestamp(cplayer.getPlaybackPos())}function updateTimestamp(e){progressInfo.innerHTML=toTimestamp(e)+" / "+progressInfoVidDurationFormatted,isMultipart&&(progressInfo2.innerHTML=toTimestamp(partOffset+e)+" / "+progressInfoStreamDurationFormatted);var a=Math.floor(videoStartTime+e),r=new Date(1e3*a).toLocaleString("en-US",{timeZone:"America/Toronto"}),i=new Date(r),o=i.getHours(),n=i.getMinutes();timeFormat24h?localTimeInfo.innerHTML=(o<10?"0"+o:o)+":"+(n<10?"0"+n:n):localTimeInfo.innerHTML=(o%12==0?12:o%12)+":"+(n<10?"0"+n:n)+" "+(o<12?"AM":"PM"),localTimeInfo.style.display="block"}var descBarVisible=!0,descBarHidingAvailable=!0;function toggleDescBar(){showDescBar(descBarVisible=!descBarVisible),recalculateSizes()}function showDescBar(e){e?(descBox.style.display="block",timelineBox.style.display="block",descBarToggleBtn.style.display="inline-block",descBarToggleBtn2.style.display="none",null!=chatTabs&&(chatTabs.style.display="block")):(descBox.style.display="none",timelineBox.style.display="none",descBarToggleBtn.style.display="none",descBarToggleBtn2.style.display="block",null!=chatTabs&&(chatTabs.style.display="none"))}var subTimelineFeatures={};function toggleSubTimeline(e,a){var r=!1;"1"==e.dataset.enabled&&(r=!0);var i=!r;if(e.style.background=i?"#6f5800":"transparent",e.dataset.enabled=i?"1":"0",i){var o=document.createElement("div");o.style.width="100%",o.style.height="50px",o.style.background="#000",o.innerHTML=loadSubTimelineFeature(a),document.getElementById("subTimelineBox").appendChild(o),subTimelineFeatures[a]=o}else a in subTimelineFeatures&&(subTimelineFeatures[a].remove(),delete subTimelineFeatures[a])}function loadSubTimelineFeature(e){if("waveform"==e)return'<div style="height: 100%; margin: 0 12px;"><img style="width: 100%; height: 100%;" src="'+staticUrl+"waveform/"+paramId+'.png"></img></div>';if("spectrogram"==e)return'<div style="height: 100%; margin: 0 12px;"><img style="width: 100%; height: 100%;" src="'+staticUrl+"spectrogram/"+paramId+'.png"></img></div>';if("timeline"==e){for(var a=document.getElementById("playerContainer").clientWidth-24,r=Math.ceil(a/88.88888888888889),i="",o=0;o<r;o++){var n,l,s=88.88888888888889*o,d=Math.floor(100*(s/a));i+='<div style="position:absolute;top:0;left:'+s+'px;height:100%;width:88.88888888888889px;">'+("<div style=\"background-size: 888.8888888888889px 500px; background-image: url('"+staticUrl+"preview2/"+paramId+".webp'); background-position: -"+d%10*88.88888888888889+"px -"+50*Math.floor(d/10)+'px;width: 100%; height: 100%;"></div>')+"</div>"}return'<div style="height: 100%; margin: 0 12px;"><div style="width: 100%; height: 100%;position:relative;overflow:hidden;">'+i+"</div></div>"}return""}var chatInit=!1,theatreMode=!1,bodyScrollTop=0;function toggleTheatre(){(theatreMode=!theatreMode)?(bodyScrollTop=window.pageYOffset||document.documentElement.scrollTop,playerContainer.className="theatre",playerChat.className="theatre",theatreModeToggleBtn.className="descBtn theatre",document.body.style.overflow="hidden"):(playerContainer.className="",theatreModeToggleBtn.className="descBtn",recalculateSizes(),document.body.style.overflow="",window.scrollTo(0,bodyScrollTop))}function playerChatModeChange(e){(descBarHidingAvailable=!e)?showDescBar(descBarVisible):(showDescBar(!0),descBarToggleBtn.style.display="none",descBarToggleBtn2.style.display="none")}function recalculateSizes(){if(!theatreMode){var e=window.innerWidth-18;if(e>=960){descBarHidingAvailable&&playerChatModeChange(!0);var a=Math.min(1024,1024-(1436-e));videoBox.style.width=a+"px",navBox.style.width=a+"px",setTimeout(()=>{boundingRect=videoBox.getBoundingClientRect(),boundingRect.y+=window.scrollY,playerChat.style.left=a+20+"px",playerChat.style.top=boundingRect.y+0+"px",playerChat.className="right";var e=2;"mixer"==videoObject.type&&(e=0),playerChat.style.height=boundingRect.height-e-0+"px",chatTabs.classList.add("right"),chatTabs.style.left=a+20+"px",chatTabs.style.top=boundingRect.y-52+0+"px"},1)}else descBarHidingAvailable||playerChatModeChange(!1),videoBox.style.width="100%",navBox.style.width="100%",setTimeout(()=>{playerChat.className="",playerChat.style.left=0,playerChat.style.top=0,playerChat.style.height=Math.min(.5*playerContainer.clientWidth,260)+"px",chatTabs.classList.remove("tabs"),chatTabs.style.left=0,chatTabs.style.top=0},1);playerContainer.style.height=playerContainer.clientWidth/16*9+"px",audioPlayerMode&&(playerContainer.style.height="250px"),chatInit||(playerChat.style.display="block",chatInit=!0),"timeline"in subTimelineFeatures&&(subTimelineFeatures.timeline.innerHTML=loadSubTimelineFeature("timeline"))}}function loadYtPlayer(e){player=new YT.Player("youtube-player",{height:"100%",width:"100%",videoId:e,playerVars:{autoplay:1},events:{onReady:function(a){progressInfoVidDurationFormatted=toTimestamp(a.target.getDuration()),void 0!==paramCue&&(a.target.cueVideoById({videoId:e,startSeconds:paramCue}),a.target.playVideo()),updateTimestampYt(),setInterval(updateTimestampYt,200),postPlayerLoad()}}}),externalAudioEnabled&&player.addEventListener("onStateChange",e=>{if(null!=externalAudio){if(1==e.data){externalAudio.play();var a=document.getElementById("clickPlayBox");a&&a.remove()}2==e.data&&externalAudio.pause()}})}var onedriveVideoObject=null;function onedriveAccessRetry(){document.getElementById("onedrive-access-notice").style.display="None",loadOneDrivePlayer(onedriveVideoObject,!0)}function onedriveAccessOverride(){var e=Math.round(+new Date/1e3);setOnedriveVerificationCookie({ct:e,lt:e,cu:uuidstr,lu:uuidstr}),loadOneDrivePlayer(onedriveVideoObject)}function setOnedriveVerificationCookie(e){var a=new Date(Date.now()+31536e6);document.cookie="d5a_onedrive_verification="+btoa(JSON.stringify(e))+"; expires="+a.toUTCString()+"; path=/"}function refreshOnedriveVerificationCookie(){try{var e=getCookie("d5a_onedrive_verification"),a=JSON.parse(atob(e)),r=Math.round(+new Date/1e3);a.lt=r,a.lu=uuidstr,setOnedriveVerificationCookie(a)}catch(i){}}function onedriveGenerateEmbedLink(e,a=null){var r="";return null!=a&&(r="&nav=%7B%22playbackOptions%22%3A%7B%22startTimeInSeconds%22%3A"+a+"%7D%7D"),e.embed_base+"?UniqueId="+e.etag+r+"&embed=%7B%22ust%22%3Atrue%7D&referrer=StreamWebApp&referrerScenario=EmbedDialog.Create"}function loadOneDrivePlayer(e,a=!1){onedriveVideoObject=e;var r=getCookie("d5a_onedrive_verification");if(null!=r){var i=Math.round(+new Date/1e3);try{var o=JSON.parse(atob(r)),n=!0,l=null;o&&"lt"in o&&o.lt<i-259200?(l="Your login likely expired",n=!1):o&&"lu"in o&&o.lu!=uuidstr&&(l="Verified with a different account",n=!1),n&&refreshOnedriveVerificationCookie(),null!=l&&(document.getElementById("overheadPlayerNotice").innerHTML='<div style="color: #111; background: #b81; width: 100%;"><div style="padding: 8px 5px;"><b>OneDrive warning</b> &emsp; '+l+' &emsp; <a class="smallButton" href="/onedrive_verification?showSetUp" target="_blank">re-verify</a> <a class="smallButton" href="#!" onclick="this.parentElement.parentElement.remove();refreshOnedriveVerificationCookie();">dismiss</a></div></div>')}catch(s){}var d=document.getElementById("youtube-player");d.style.width="100%",d.style.height="100%",d.innerHTML='<table border="0" style="width:100%;height:100%;"><tr><td><div style="text-align:center;"><img src="/media/loading.gif"><br><br><b style="opacity:0.5;">Preparing the embed...</b></div></td></tr></table>',getFolderShareLink(e.folder,a=>{var r=a.sharing_link;console.log("preload url: "+r);var i=document.createElement("iframe");i.setAttribute("src",r),i.style.width="640px",i.style.height="480px",i.style.position="fixed",i.style.top="0",i.style.left="-1000px";var o=function(){var a=null;void 0!==paramCue&&(a=paramCue);var r=onedriveGenerateEmbedLink(e,a);console.log("embed url: "+r),(onedriveEmbed=document.createElement("iframe")).setAttribute("src",r),onedriveEmbed.style.width="100%",onedriveEmbed.style.height="100%",onedriveEmbed.frameBorder="0",onedriveEmbed.scrolling="no",onedriveEmbed.allowFullscreen=!0,i.remove(),d.innerHTML="",d.appendChild(onedriveEmbed),onedrivePlayerEmbed=onedriveEmbed,progressInfo.innerHTML="",postPlayerLoad()};i.onload=o,document.body.appendChild(i)})}else a&&mkToast("not verified yet","f55"),document.getElementById("onedrive-access-notice").style.display="block"}function loadCustomPlayerHls(e){resolveUrlOrUrlDynamic(e,e=>{var a={type:"video",src:e,hls:!0};"hasScrubbing"in videoObject&&!0==videoObject.hasScrubbing&&(a.scrubbing={density:videoObject.scrubbingDensity,url:staticUrl+"scrubbing/V"+paramId+"L1T@offset.webp",atlas:[10,12],url2:staticUrl+"scrubbing/V"+paramId+"L2T@offset.webp",atlas2:[5,6]}),void 0!==paramCue&&(a.start=paramCue),loadCustomPlayer(a)})}function loadCustomPlayerAudio(e){resolveUrlOrUrlDynamic(e,e=>{var a={type:"audio",src:e};"hasWaveform"in videoObject&&!0==videoObject.hasWaveform&&(a.waveform=staticUrl+"waveform/"+paramId+".png"),void 0!==paramCue&&(a.start=paramCue),audioPlayerMode=!0,loadCustomPlayer(a)})}function loadCustomPlayer(e){document.getElementById("youtube-player").style.height="100%";var a=document.createElement("script");a.onload=function(){e.ready=function(){progressInfoVidDurationFormatted=toTimestamp(cplayer.getDuration())},cplayer=createCustomPlayer("youtube-player",e),updateTimestampCustom(),setInterval(updateTimestampCustom,200),postPlayerLoad()},a.src="/media/cplayer_api.js",document.head.appendChild(a)}function embedHelp(){var e="";"youtube"==providerTypeForId[preferredProvider]?(e+="<li><b>Do not use incognito mode</b><br>This can prevent the embed from working in some cases</li>",e+="<li><b>Disable tracking protection extensions or features</b><br>These can prevent the embed from working in some cases.</li>"):"onedrive"==providerTypeForId[preferredProvider]&&(e+="<li><b>Do not use firefox!</b><br>Unfortunately, iframe behaviour is not up to spec for this specific use case here and the video will just not load in firefox. Please use Chrome.</li>",e+="<li><b>Do not use incognito mode</b><br>This can prevent the embed from working in some cases</li>",e+="<li><b>Disable tracking protection extensions or features</b><br>These can prevent the embed from working in some cases, especially since we need to be signed in in the embed so cookies need to be loaded properly.</li>",e+='<li><b>Make sure OneDrive access is set up</b><br>If you have recently cleared cookies, haven\'t used this site in a while it might be a good idea to re-verify your OneDrive access: <a class="shade" href="/onedrive_verification?showSetUp" target="_blank">re-verify</a></li>'),e=""==e?'no elp <img src="/media/nopers.webp" height="30px" alt="nopers" title="nopers"> <br><br>':"<ul>"+e+"</ul>",document.getElementById("overheadPlayerNotice").innerHTML='<div style="width: 100%;"><div style="border: 1px solid #555; padding: 10px;"><b>Embed help</b> <br><br>'+e+'<br> <a class="smallButton" href="#!" onclick="this.parentElement.parentElement.remove();">dismiss</a></div></div>'}function postPlayerLoad(){loadMarkers(),loadTags(),loadChat()}function loadChat(){var e=document.getElementById("chat");if(recalculateSizes(),!hasChat){e.innerHTML='<span style="opacity:0.6;">\uD83D\uDCAC\uD83D\uDEAB Chat replay unavailable.</span>';return}var a,r=paramId,i=partOffset;dontShowChatHeader=!0,displayChat(r,e,!1,videoObject.type,i)}function markerColorChange(e,a){var r=document.getElementById("mcol-"+a);r&&(r.style.fill=e.value)}function btnMarkerDiscard(e,a,r){e||(delete markers[a],reloadMarkerList()),rmMarkerElem(e?null:a,r)}function rmMarkerElem(e,a){if(e){var r=document.getElementById("marker-"+e);r&&(r.outerHTML="")}clWindow(a)}function clWindow(e){if(e){var a=document.getElementById(e);a&&(a.outerHTML="")}}function delMarker(e){confirm("Delete marker '"+markers[e].name+"' @ '"+toTimestamp(markers[e].time)+"'?")&&markerDestory(e,a=>{btnMarkerDiscard(!1,e,null)})}function editMarker(e){mkMarkerEditWindow(!0,e,event.clientX+12,event.clientY-12)}function btnMarkerSave(e,a,r){var i=JSON.parse(JSON.stringify(markers[a]));delete i.temp,i.name=document.getElementById("editMarkerName").value.trim(),i.color=document.getElementById("editMarkerColor").value;var o=-1,n=document.getElementById("editMarkerTime").value;if(/^(\d+\:)?(\d+\:)?\d+$/.test(n)){var l=n.split(":").reverse(),s=1,d=0;for(t of l)d+=parseInt(t)*s,s*=60;d<0||d>videoDuration?mkToast("invalid timecode (must be within video time span)!","f55"):o=d}else mkToast("invalid timecode (syntax)! please use hh:mm:ss","f55");-1!=o&&(i.time=partOffset+o,e?markerUpdate(a,i,e=>{rmMarkerElem(a,r),loadMarkersFromApi(()=>{})}):markerCreate(vidIdMrk,i,e=>{loadMarkersFromApi(()=>{rmMarkerElem(a,r)})}))}function loadMarkersFromApi(e=null){getMarkersVideo(vidIdMrk,a=>{var r={};if(vidIdMrk in a)for(let i of a[vidIdMrk]){var o=i.offset;(!isMultipart||!((o-=partOffset)<0)&&!(o>videoDuration))&&(r[i.id]={color:"#"+i.color,time:o,name:i.text,user:i.by})}markers=r,reloadMarkerList(),e&&e()})}function editMarkerKeypress(e,a,r){"Enter"===event.key?btnMarkerSave(e,a,r):"Escape"===event.key&&btnMarkerDiscard(e,a,r)}function loadMarkers(){if(0!=videoDuration){var e=document.getElementById("tl_markers"),a=document.createElement("div");a.style.color="white",a.style.background="rgba(0,0,0,0.8)",a.style.padding="5px",a.style.display="none",a.style.position="fixed",a.style.fontSize="smaller",a.innerHTML="click to add a marker",document.body.appendChild(a);var r=document.createElement("div");r.style.background="yellow",r.style.width="1px",r.style.height="32px",r.style.position="absolute",r.style.display="none",r.style.pointerEvents="none",e.style.cursor="pointer",e.addEventListener("mouseleave",e=>{r.style.display="none",a.style.display="none"}),e.addEventListener("click",a=>{if(!session){showLoginPane("you need to login to create markers");return}var r=a.clientX,i=e.getBoundingClientRect().left,o=e.getBoundingClientRect().top,n=(r-i)/parseFloat(e.clientWidth);if(n>=0&&n<=1){var l="#"+Math.random().toString(16).substr(2,6);markers.tmp={color:l,time:parseInt(n*videoDuration),name:"(new marker)",user:"local",temp:!0},mkMarkerEditWindow(!1,"tmp",r+10,o+6)}}),e.addEventListener("mousemove",i=>{var o=i.clientX,n=e.getBoundingClientRect().left,l=o-n,s=e.clientWidth,d="";if(l>=0){r.style.display="block";var c=l/parseFloat(s);r.style.left=100*c+"%",d="click to add a marker at <b>"+toTimestamp(parseInt(c*videoDuration))+"</b>"}else r.style.display="none";for(var p="",m=i.target,v=null;null!=m;)"markerId"in m.dataset&&(v=m.dataset.markerId),m=m.parentElement;if(null!=v&&v in markers){var u=markers[v];p=colDot(u.color)+" <b>"+toTimestamp(u.time)+"</b>&emsp;"+escapeHtml(u.name)+"<br>"}""!=(markerText=p+d)&&(a.innerHTML=markerText,a.style.display="block");var g=a.clientWidth,y=n-12,b=n+s+12-g;a.style.top=e.getBoundingClientRect().bottom+"px";var h=n+l;(h-=g/2)<y&&(h=y),h>b&&(h=b),a.style.left=h+"px"}),e.appendChild(r),chatTabs.classList.add("tabs"),chatTabs.innerHTML+='<a id="tabheader-chat" onclick="openTab(\'chat\')" class="active'+(hasChat?"":" strike")+'" href="#!">Chat</a>',chatTabs.innerHTML+='<a id="tabheader-markers" onclick="openTab(\'markers\')" href="#!">Markers</a>',(markersPane=document.createElement("div")).style.padding="10px",markersPane.style.display="none",markersPane.innerHTML='<div id="markerlist"></div><br><div id="markersettings" style="diplay: none;"><b>Marker settings</b><br><label><input onclick="toggleMarkers(\'mine\')" checked type="checkbox"></input> show mine</label>&emsp;<label><input onclick="toggleMarkers(\'community\')" checked type="checkbox"></input> show community</label></div>',playerChat.appendChild(markersPane),hasChat||openTab("markers"),loadMarkersFromApi()}}markers={};var markersEnabledMine=!0,markersEnabledCommunity=!0;function toggleMarkers(e){"mine"==e?markersEnabledMine=!markersEnabledMine:"community"==e&&(markersEnabledCommunity=!markersEnabledCommunity),reloadMarkerList()}function mkMarkerEditWindow(e,a,r,i){var o="win-edit-marker";rmMarkerElem("tmp",o),e||reloadMarkerList();var n="",l="editMarkerKeypress("+e+", '"+a+"', '"+o+"')",s="markerColorChange(this, '"+a+"')";e&&(n=escapeHtml(markers[a].name),s="");var d=markers[a].color,c=toTimestamp(markers[a].time),p='<input type="text" id="editMarkerName" placeholder="marker name" value="'+n+'" onkeydown="'+l+'"> ';p+='<button title="[esc]" onclick="'+("btnMarkerDiscard("+e+", '"+a+"', '")+o+"')\">&nbsp;x&nbsp;</button><br>",p+='<b>@</b><input type="text" id="editMarkerTime" placeholder="timecode" value="'+c+'" onkeydown="'+l+'"><br>',p+='<input onchange="'+s+'" style="border:none;padding:0;margin-top:6px;width:16px;height:16px;" type="color" id="editMarkerColor" value="'+d+'"> ',p+='<button title="[enter]" onclick="'+("btnMarkerSave("+e+", '"+a+"', '")+o+"')\">save</button>",mkWindow(o,r,i,p+='<br><i style="font-size:smaller;opacity:0.6;"><img title="info" src="/media/info.png" height="18px" style="vertical-align:bottom;">markers are public</i>'),document.getElementById("editMarkerName").focus()}function mkWindow(e,a,r,i){var o=document.createElement("div");o.style.color="white",o.style.background="#334455",o.style.border="1px solid #112233",o.style.padding="5px",o.style.display="block",o.style.position="fixed",o.style.minWidth="250px",o.style.top=r+"px",o.style.left=a+"px",o.innerHTML=i,o.id=e,document.body.appendChild(o),windowJustify(e)}function windowJustify(e){var a=document.getElementById(e);if(a){var r=a.getBoundingClientRect(),i=r.top,o=r.left,n=r.width,l=r.height,s=window.innerWidth,d=window.innerHeight;o<0&&(o=0),i<0&&(i=0),o>s-n&&(o=s-n),i>d-l&&(i=d-l),a.style.top=i+"px",a.style.left=o+"px"}}function reloadMarkerList(){var e=document.getElementById("markerlist");if(null!=e){var a=document.getElementById("tl_markers"),r=[];for(var i in markers)r.push(i);r.sort((e,a)=>markers[e].time-markers[a].time);var o="";for(var i of r){var n=markers[i],l=n.user==username,s="marker-"+i,d=document.getElementById(s);if(null==d){var c=getNode("svg",{width:20,height:20}),p=getNode("rect",{x:9.142,y:-5,width:10,height:10,transform:"rotate(45)",rx:2,ry:2,fill:n.color,stroke:"black",strokeWidth:2});p.dataset.markerId=i,p.id="mcol-"+i,c.appendChild(p),c.style.position="absolute",c.style.marginLeft="-10px",c.style.top="6px";var m=n.time/parseFloat(videoDuration);c.style.left=100*m+"%",c.id=s,a.appendChild(c),d=c}var v="initial";if(l&&!markersEnabledMine&&(v="none"),l||markersEnabledCommunity||(v="none"),d.style.display=v,!("temp"in n&&n.temp)){var u=escapeHtml(n.name),g="",y=n.user;if(l){if(!markersEnabledMine)continue;g+='<a class="markerEditLink" onclick="editMarker('+i+')" href="#!">edit</a> ',g+='<a class="markerEditLink del" onclick="delMarker('+i+')" href="#!">x</a> ',y='<span title="you" style="color:#47f;">'+y+"</span>"}else if(!markersEnabledCommunity)continue;""==n.name&&(u='<span style="color:#555;">[unnamed]</span>'),o+='<div><a class="timestamp" href="?v='+paramId+(isMultipart?"&p="+(nPartId+1):"")+"&t="+n.time+'" onclick="return jumpTo('+n.time+');">'+toTimestamp(n.time)+"</a>&ensp;"+colDot(n.color)+"&emsp;"+u+'&emsp;<i style="color:gray;">by '+y+"</i> "+g+"</div>"}}e.innerHTML=o,document.getElementById("markersettings").style.display=session?"block":"none"}}function getNode(e,a){for(var r in e=document.createElementNS("http://www.w3.org/2000/svg",e),a)e.setAttributeNS(null,r.replace(/[A-Z]/g,function(e,a,r,i){return"-"+e.toLowerCase()}),a[r]);return e}function openTab(e){var a=document.getElementById("tabheader-chat"),r=document.getElementById("tabheader-markers");null!=a&&(a.className=a.className.replace("active","")),null!=r&&(r.className=r.className.replace("active",""));var i=null==chatElement?document.getElementById("chat"):chatElement;"chat"==e?(i.style.display="block",null!=markersPane&&(markersPane.style.display="none"),null!=a&&(a.className+=" active")):"markers"==e&&(i.style.display="none",null!=markersPane&&(markersPane.style.display="block"),null!=r&&(r.className+=" active"))}var globalCategoryList=[],videoTags=[];function loadTags(){reloadCategoryList(()=>{document.getElementById("videotags").dataset.enabled="1",loadVideoTagsFromApi()})}function loadVideoTagsFromApi(e=null){getTagsVideo(vidId,a=>{videoTags=vidId in a?a[vidId]:[],reloadTagList(),e&&e()})}function reloadCategoryList(e=null){getCategories(a=>{var r={};for(var i in a){var o=a[i];o.color="#"+o.color,r[i]=o}globalCategoryList=r,e&&e()})}function reloadTagList(){var e=document.getElementById("videotags");if("1"!=!e.dataset.enabled){var a=videoTags;a.sort((e,a)=>{var r=e in globalCategoryList?globalCategoryList[e].count:0;return(a in globalCategoryList?globalCategoryList[a].count:0)-r});var r="";for(var i of a)if(i in globalCategoryList){var o=globalCategoryList[i],n="";session&&(n=' <a class="markerEditLink del" href="#!" onclick="videoUntag('+i+')">x</a>'),r+='<span class="videotag">'+colDot(o.color)+" "+escapeHtml(o.text)+n+"</span> "}e.innerHTML=r+'<span class="videotag add" onclick="videoAddTag()">&nbsp;+&nbsp;</span'}}function videoAddTag(){if(!session){showLoginPane("you need to login to add tags");return}var e=event.clientX+12,a=event.clientY-12,r="win-add-tag";clWindow(r);var i='<input type="text" id="tagSearchField" placeholder="search tags" value="" onkeydown="tagSearchKeypress(false)" onkeyup="tagSearch()"> ';i+='<button title="[esc]" onclick="clWindow(\''+r+"')\">&nbsp;x&nbsp;</button><br>",i+='<div id="tagSearchResults" style="max-width: 500px;"></div>',i+='<span style="font-size: smaller;"><a href="#!" class="shade" onclick="showNewTagForm()">Create a new tag</a></span>',mkWindow(r,e,a,i+='<br><div id="newTag" style="display:none;"><input type="text" id="newTagName" placeholder="new tag name" value="" onkeydown="tagSearchKeypress(true)"> <input style="border:none;padding:0;width:16px;height:16px;" type="color" id="newTagColor" value="#'+Math.random().toString(16).substr(2,6)+'"> <button onclick="createNewTag()">add</button></div>'),tagSearch(),document.getElementById("tagSearchField").focus()}function tagSearchKeypress(e){if("Enter"===event.key){if(e)createNewTag();else{var a=document.getElementById("tagSearchResults").dataset;if(a.hasOwnProperty("first")){var r=a.first;-1!=r&&videoTag(r)}}}else"Escape"===event.key&&clWindow("win-add-tag")}function tagSearch(e=!1){var a="",r=document.getElementById("tagSearchField").value.toLowerCase().trim(),i=0,o=[],n=[];for(var l in globalCategoryList)n.push(l);var s=n;for(var l of(s.sort((e,a)=>{var r=e in globalCategoryList?globalCategoryList[e].count:0;return(a in globalCategoryList?globalCategoryList[a].count:0)-r}),s)){var d=globalCategoryList[l];(""==r||-1!==d.text.toLowerCase().indexOf(r))&&!videoTags.includes(parseInt(l))&&(o.push({id:l,obj:d}),i++)}o.sort((e,a)=>a.obj.count-e.obj.count),e||(o=o.slice(0,20));var c=-1;for(res of o){var l=res.id,d=res.obj;-1==c&&(c=l),a+='<span class="videotag clickable" onclick="videoTag('+l+')" title="click to add">'+colDot(d.color)+" "+escapeHtml(d.text)+' <span class="count">'+d.count+"</span></span> "}a+='<span style="color:#888;">';var p=i-o.length;p>0&&(a+='<span title="enter a search term to refine results">...'+p+' more</span> <a class="shade" onclick="tagSearch(true)">show</a> '),a+="["+i+"/"+s.length+"]",a+="</span>",document.getElementById("tagSearchResults").innerHTML=a,document.getElementById("tagSearchResults").dataset.first=c,windowJustify("win-add-tag")}function showNewTagForm(){document.getElementById("newTag").style.display="block",document.getElementById("newTagName").value=document.getElementById("tagSearchField").value,document.getElementById("newTagName").focus(),windowJustify("win-add-tag")}function setTagsVideoAdjustCount(e,a,r,i){setTagsVideo(e,a,r,e=>{a in globalCategoryList&&(globalCategoryList[a].count=e.new_count),i&&i(e)})}function videoTag(e){clWindow("win-add-tag"),videoTags.includes(e)||setTagsVideo(vidId,e,!0,e=>{loadVideoTagsFromApi()})}function videoUntag(e){clWindow("win-add-tag"),setTagsVideoAdjustCount(vidId,e,!1,a=>{loadVideoTagsFromApi(()=>{if(e in globalCategoryList){var a=globalCategoryList[e];0==a.count&&confirm("The tag '"+a.text+"' isn't being used on any video anymore.\nDo you want to delete it now?")&&tagDestroy(e,()=>{reloadCategoryList()})}})})}function createNewTag(){var e=document.getElementById("newTagName").value.trim(),a=document.getElementById("newTagColor").value;if(0==e.length){mkToast("please enter a tag name","f55");return}tagCreate(vidId,{name:e,color:a},e=>{clWindow("win-add-tag"),reloadCategoryList(()=>{videoTag(e.id)})})}function colDot(e){return'<div style="vertical-align:baseline;display:inline-block;width:10px;height:10px;background:'+e+';border-radius:6px;"></div>'}function readTimeFromUrl(){var e=new URL(window.location.href).searchParams.get("t");if(null!=e){var e=e.trim();if(0==e.length)return -1;if(/^(\d+h)?(\d+m)?(\d+s?)?$/.test(e)){var a=/^(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s?)?$/.exec(e);return console.log(a),(void 0==a[1]?0:3600*parseInt(a[1]))+(void 0==a[2]?0:60*parseInt(a[2]))+(void 0==a[3]?0:parseInt(a[3]))}if(/^(\d+\:){0,2}\d+$/.test(e)){var a=/^(?:(?:(\d+)\:)?(\d+)\:)?(\d+)$/.exec(e);return console.log(a),(void 0==a[1]?0:3600*parseInt(a[1]))+(void 0==a[2]?0:60*parseInt(a[2]))+parseInt(a[3])}}return -1}function ar_login(){showLoginPane("log in to view video")}function ar_connecthelptext(){infoPopup("why-discord")}